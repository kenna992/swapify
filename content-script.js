const e={DEBUG:0,INFO:1,WARN:2,ERROR:3},t="AUTH",s="HIGH";class o{constructor(t,s=e.INFO){this.component=t,this.minLevel=s,this.errorCount=0;try{this.isDev=chrome.runtime.getManifest().version_name?.includes("dev"),this.isProduction=!this.isDev}catch(o){this.isDev=!1,this.isProduction=!0}}log(t,s,o=null){if(t<this.minLevel)return;if(this.isProduction&&t<e.WARN)return;const r=Object.keys(e).find(s=>e[s]===t);(new Date).toISOString().substr(11,12),this.component}debug(t,s){this.log(e.DEBUG,t,s)}info(t,s){this.log(e.INFO,t,s)}warn(t,s){this.log(e.WARN,t,s)}error(t,s){this.errorCount++,this.log(e.ERROR,t,s)}logError(t,s,o,r=null,n={}){this.errorCount++;const a={category:t,severity:s,error:r?{message:r.message,stack:r.stack}:null,context:n,timestamp:(new Date).toISOString()};this.log(e.ERROR,`[${t}][${s}] ${o}`,a)}}new o("ContentScript");const r=new o("Auth");new o("GraphQL");const n=new Promise((e,o)=>{const n=a=>{if(a.source!==window||"FROM_INJECTOR_SCRIPT"!==a.data?.type)return;const{success:i,data:c,error:d}=a.data.payload;i?(r.info("Securely received page-level tokens:",c),e(c)):(r.logError(t,s,"Injector script failed",new Error(d)),o(new Error("Could not get page-level tokens from injector script."))),window.removeEventListener("message",n)};window.addEventListener("message",n,!1);try{const e=document.createElement("script");e.src=chrome.runtime.getURL("injector.js"),(document.head||document.documentElement).appendChild(e),e.onload=()=>e.remove()}catch(a){o(new Error(`Failed to inject the secure token extractor: ${a.message}`)),window.removeEventListener("message",n)}});let a=[],i={isScanning:!1,enabledGroups:[],keywords:[],settings:{},currentGroupIndex:0,totalProcessed:0,totalMatches:0,iframe:null,currentScanId:null};const c="LOCAL_LSD",d="LOCAL_JAZOEST",u="LOCAL_SITE_DATA",l="LOCAL_DYN",_="LOCAL_CSR",p="LOCAL_STATIC_VALUES",m={header:{},body:{}};class f{constructor(){this.bits=[],this.compressedString=null}set(e){this.bits=e}toString(){const e=this.bits.map(e=>e?"1":"0").join("");return e.length?e:""}toCompressedString(){if(0===this.bits.length)return"";if(null!==this.compressedString)return this.compressedString;const e=[...this.bits];let t=1,s=e[0]?1:0,o=s.toString(2);for(let n=1;n<e.length;n++){const r=e[n]?1:0;r===s?t++:(o+="0".repeat(t.toString(2).length-1)+t.toString(2),s=r,t=1)}o+="0".repeat(t.toString(2).length-1)+t.toString(2);let r="";for(let n=0;n<o.length;n+=6){const e=o.slice(n,n+6);r+="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ-_"[parseInt(e,2)]}return this.compressedString=r,r}}function g(){return Math.floor(200*Math.random())+500}function h(){try{return window[c]||crypto.randomUUID()}catch(e){return crypto.randomUUID()}}function w(){try{return window[d]||25135}catch(e){return 25135}}function y(){const e={__hs:"19478.HYP:comet_pkg.2.1..2.1",__hsi:"7228238052909620565"};try{return window[u]?window[u]:e}catch(t){return e}}function S(){try{if(window[l])return window[l];const e=new f,t=new Array(1600).fill(null),s=[],o=g();for(let n=0;n<o;n++){let e=Math.floor(1600*Math.random());for(;s.includes(e);)e=Math.floor(1600*Math.random());s.push(e),t[e]=1}e.set(t);const r=e.toCompressedString();return window[l]=r,r}catch(e){return crypto.randomUUID()}}function I(){try{if(window[_])return window[_];const e=new f,t=new Array(1800).fill(null),s=[],o=g();for(let n=0;n<o;n++){let e=Math.floor(1800*Math.random());for(;s.includes(e);)e=Math.floor(1800*Math.random());s.push(e),t[e]=1}e.set(t);const r=e.toCompressedString();return window[_]=r,r}catch(e){return crypto.randomUUID()}}function E(){function e(){const e="abcdefghijklmnopqrstuvwxyz0123456789",t=[4,5,6,7,8],s=t[Math.floor(Math.random()*t.length)];let o="";for(let r=0;r<s;r++)o+=e.charAt(Math.floor(36*Math.random()));return o}const t=Math.random()<.3?2:3,s=[];for(let o=0;o<t;o++)s.push(e());return s.join(":")}async function b(){try{if(!window.location.hostname.includes("facebook.com"))throw new Error("Not in Facebook context - cannot extract tokens");if(window.LOCAL_FB_DTSG&&window.LOCAL_TOKENS_CACHE){const e=window.LOCAL_TOKENS_CACHE;if(Date.now()-e.timestamp<3e5)return e}let s="";try{const e=await fetch("https://www.facebook.com/",{headers:{accept:"text/html","cache-control":"no-cache",pragma:"no-cache"}});if(!e.ok)throw new Error(`Failed to fetch homepage: ${e.status}`);s=await e.text()}catch(e){s=document.documentElement.innerHTML}let o=null,r=null,a=null,i=null,l={};try{const e=await n;a=e.lsd,i=e.jazoest,a&&(window[c]=a),i&&(window[d]=i)}catch(t){}if(i)l.jazoest=i;else try{const e=s.split('jazoest","value":"')[1]?.split('"')[0];e&&(i=e,l.jazoest=e,window[d]=e)}catch(t){const e=s.match(/name="jazoest" value="(\d+)"/);e&&e[1]&&(i=e[1],l.jazoest=e[1])}if(!a)try{const e=s.split('["LSD",[],{"token":"')[1]?.split('"')[0];e&&(a=e,window[c]=e)}catch(t){const e=[/"LSD".*?"token":"([^"]+)"/,/"lsd":"([^"]+)"/,/name="lsd" value="([^"]+)"/,/"LsdToken":"([^"]+)"/];for(const o of e){const e=s.match(o);if(e){a=e[1],window[c]=e[1];break}}}try{const e=s.split('"SiteData",[],{')[1]?.split("}")[0];if(e){const t=JSON.parse(`{${e}}`);l={__hs:t.haste_session?.replace("comet_plat_default_pkg","comet_pkg")||l.__hs,__rev:t.client_revision||l.__rev,__hsi:t.hsi||l.__hsi,__spin_r:t.__spin_r||l.__spin_r,__spin_b:t.__spin_b||l.__spin_b,__spin_t:t.__spin_t||l.__spin_t},window[u]=l}}catch(t){}try{const e=s.split('"AD_ACCOUNT_ID":"')[1]?.split('"')[0];e&&(l.__aaid=e.toString())}catch(t){const e=[/"X-ASBD-ID":"([^"]+)"/,/"ASBD_ID":"([^"]+)"/,/X-ASBD-ID['"]\s*:\s*['"]([^'"]+)['"]/];for(const o of e){const e=s.match(o);if(e){l.__aaid=e[1];break}}}l.__hs||(l.__hs=`${Math.floor(9e4*Math.random())+1e4}.HYP:comet_pkg.2.1...0`),l.__rev||(l.__rev=Math.floor(9e8*Math.random())+1e9),l.__hsi||(l.__hsi=Math.floor(9e18*Math.random())+1e18),l.__spin_r||(l.__spin_r=Math.floor(9e8*Math.random())+1e9),l.__spin_b||(l.__spin_b="trunk"),l.__spin_t||(l.__spin_t=Date.now()),l.__aaid||(l.__aaid="359341");try{const e=s.split("DTSGInitialData")[1]?.split('"token":"')[1]?.split('"')[0];e&&(o=e,window.LOCAL_FB_DTSG=e)}catch(t){const e=[/"DTSGInitialData",\[\],{"token":"([^"]+)"/,/"fb_dtsg":"([^"]+)"/,/"DTSGInitData".*?"token":"([^"]+)"/,/fb_dtsg['"]\s*:\s*['"]([^'"]+)['"]/];for(const r of e){const e=s.match(r);if(e){o=e[1],window.LOCAL_FB_DTSG=e[1];break}}}try{const e=s.match(/"USER_ID":"(\d+)"/);e&&(r=e[1])}catch(t){}if(!o||!r)throw new Error("Critical tokens (fb_dtsg or userId) could not be extracted.");const _={fb_dtsg:o,userId:r,lsd:a,...l,timestamp:Date.now(),url:window.location.href,context:"facebook-isolated"};return window.LOCAL_TOKENS_CACHE=_,_}catch(s){return{error:s.message}}}async function v(e){try{let t=[],s=null,o=!0,r=0,n=null;const a=5;for(;o&&r<a;){const i={ordering:["viewer_visitation"],scale:2,count:20};s&&(i.cursor=s);const c={"Content-Type":"application/x-www-form-urlencoded","X-FB-Friendly-Name":"GroupsCometJoinsRootQuery","X-FB-LSD":e.lsd||"","X-ASBD-ID":e.__aaid||"359341","Sec-Fetch-Dest":"empty","Sec-Fetch-Mode":"cors","Sec-Fetch-Site":"same-origin"},d=new URLSearchParams({av:e.userId||"",__user:e.userId||"",__a:"1",__req:"1",dpr:"1",__ccg:"EXCELLENT",__rev:"1016617322",__comet_req:"15",fb_dtsg:e.fb_dtsg||"",jazoest:"25570",lsd:e.lsd||"",__spin_r:e.__spin_r||"1016617322",__spin_b:e.__spin_b||"trunk",__spin_t:e.__spin_t||"1737462358",fb_api_caller_class:"RelayModern",fb_api_req_friendly_name:"GroupsCometJoinsRootQuery",variables:JSON.stringify(i),server_timestamps:"true",doc_id:"9273867932733772"}),u=await fetch("https://www.facebook.com/api/graphql/",{method:"POST",headers:c,body:d,credentials:"same-origin"});if(!u.ok)throw new Error(`Groups request failed: ${u.status} ${u.statusText}`);const l=(await u.text()).replace(/^for \(;;\);/,""),_=JSON.parse(l);if(_.errors&&_.errors.length>0){_.errors.forEach((e,t)=>{});break}let p=[];if(_.data?.viewer?.all_joined_groups?.tab_groups_list?.edges){const e=_.data.viewer.all_joined_groups.tab_groups_list.edges;for(const t of e){const e=t.node;e&&e.id&&e.name&&(p.length<3&&(p.length,Object.keys(e),e.viewer_last_visited_time,e.viewer_last_visited_time),p.push({id:e.id,name:e.name,url:e.url||`https://www.facebook.com/groups/${e.id}`,memberCount:0,profile_picture:e.profile_picture?.uri||null,viewer_last_visited_time:e.viewer_last_visited_time||null,lastVisited:e.viewer_last_visited_time?1e3*e.viewer_last_visited_time:null,fetched_at:Date.now()}))}n=_.data.viewer.all_joined_groups.tab_groups_list.page_info}else if(_.data?.viewer?.groups?.edges){for(const e of _.data.viewer.groups.edges){const t=e.node;t&&t.id&&t.name&&p.push({id:t.id,name:t.name,url:t.url||`https://www.facebook.com/groups/${t.id}`,memberCount:t.member_count||0,profile_picture:t.profile_picture?.uri||null,viewer_last_visited_time:t.viewer_last_visited_time||null,lastVisited:t.viewer_last_visited_time?1e3*t.viewer_last_visited_time:null,fetched_at:Date.now()})}n=_.data.viewer.groups.page_info||null}p.length,t.push(...p),n&&n.has_next_page&&n.end_cursor?(s=n.end_cursor,o=!0,s.substring(0,20)):o=!1,r++,o&&r<a&&await new Promise(e=>setTimeout(e,1e3))}return t.length,t.slice(0,3).map(e=>({name:e.name,viewer_last_visited_time:e.viewer_last_visited_time,timestamp_ms:e.viewer_last_visited_time?1e3*e.viewer_last_visited_time:0,date_readable:e.viewer_last_visited_time?new Date(1e3*e.viewer_last_visited_time).toISOString():"No timestamp"})),t.sort((e,t)=>{const s=e.viewer_last_visited_time?1e3*e.viewer_last_visited_time:0;return(t.viewer_last_visited_time?1e3*t.viewer_last_visited_time:0)-s}),t.slice(0,3).map(e=>({name:e.name,viewer_last_visited_time:e.viewer_last_visited_time,timestamp_ms:e.viewer_last_visited_time?1e3*e.viewer_last_visited_time:0,date_readable:e.viewer_last_visited_time?new Date(1e3*e.viewer_last_visited_time).toISOString():"No timestamp"})),{success:!0,groups:t,pageInfo:n}}catch(t){return{success:!1,error:t.message}}}async function C(e){try{const t=await async function(){try{if(!window.location.hostname.includes("facebook.com"))return{isSignedIn:!1,firstName:"",fullName:"",profilePicture:"",userId:"",context:"fallback"};let t="",s={isSignedIn:!1,firstName:"",fullName:"",profilePicture:"",userId:"",context:"facebook"};try{if(t=document.documentElement.innerHTML,!t.includes("USER_ID")&&!t.includes("CurrentUserInitialData")){const e=await fetch("https://www.facebook.com/",{headers:{accept:"text/html","cache-control":"max-age=0","viewport-width":"951","sec-fetch-user":"?1"}});e.ok&&(t=await e.text())}}catch(e){t=document.documentElement.innerHTML}try{const e=[/"USER_ID":"(\d+)"/,/"viewerID":"(\d+)"/,/"viewer":{"id":"(\d+)"/,/"ActorID":"(\d+)"/];for(const o of e){const e=t.match(o);if(e){s.userId=e[1];break}}}catch(e){}try{const e=[/"CurrentUserInitialData"[^}]*"NAME":"([^"]+)"/,/"USER_SHORT_NAME":"([^"]+)"/,/"firstName":"([^"]+)"/,/"viewer":{"short_name":"([^"]+)"/];for(const o of e){const e=t.match(o);if(e){const t=e[1];if(t&&t.length>0&&!t.includes("{")&&!t.includes('"')){s.firstName=t.split(" ")[0],s.fullName=t;break}}}if(!s.fullName&&s.userId){const e=new RegExp(`"name":"([^"]+)"[^}]*"id":"${s.userId}"`),o=t.match(e);if(o){const e=o[1];e&&e.length>0&&!e.includes("{")&&!e.includes('"')&&(s.firstName=e.split(" ")[0],s.fullName=e)}}}catch(e){}try{const e=[/"profile_pic_large":"([^"]+)"/,/"profile_picture":{"uri":"([^"]+)"/,/"profilePicture":{"uri":"([^"]+)"/,/"profile_pic_url_medium":"([^"]+)"/,/"profile_pic_url":"([^"]+)"/];for(const o of e){const e=t.match(o);if(e){let t=e[1];if(t.includes("\\u")&&(t=t.replace(/\\u([0-9a-fA-F]{4})/g,(e,t)=>String.fromCharCode(parseInt(t,16)))),t.includes("\\")&&(t=t.replace(/\\\//g,"/")),t.startsWith("http")){s.profilePicture=t;break}}}}catch(e){}return s.isSignedIn=!(!s.userId||"0"===s.userId),s.isSignedIn,s.firstName,s.fullName,s.profilePicture,s.userId,s}catch(t){return{error:t.message,isSignedIn:!1,firstName:"",fullName:"",profilePicture:"",userId:"",context:"error"}}}();e.source.postMessage({type:"USER_PROFILE_RESPONSE",requestId:e.data.requestId,profile:t},e.origin)}catch(t){e.source.postMessage({type:"USER_PROFILE_RESPONSE",requestId:e.data.requestId,error:t.message},e.origin)}}async function k(e){try{e.data.group;const t=await async function(e,t,s,o=null){const r="object"==typeof e?e.id:e,n="object"==typeof e?e.name:`Group ${r}`,a="object"==typeof e?e.url:null;try{const e=s.postsPerScan||6;if(!(o||(o=await b())&&o.fb_dtsg&&o.lsd))throw new Error("Failed to extract required Facebook tokens");const i=await async function(e,t,s=null,o={}){const r=o.postsPerScan||18;const n=await async function(e){try{if("www.facebook.com"===window.location.hostname)return new Promise(t=>{const s=`preload_posts_${Date.now()}_${Math.random()}`,o=e=>{if("GET_ALL_SCANNED_POST_IDS_RESPONSE"===e.data.type&&e.data.requestId===s){window.removeEventListener("message",o);const s=e.data.postIds||[],r=new Set(s);r.size,t(r)}};setTimeout(()=>{window.removeEventListener("message",o),t(new Set)},1e4),window.addEventListener("message",o),window.parent.postMessage({type:"GET_ALL_SCANNED_POST_IDS",requestId:s,groupId:e},"*")});{const t=await chrome.runtime.sendMessage({type:"getAllScannedPostIds",groupId:e});if(t?.success){const e=new Set(t.postIds||[]);return e.size,e}return new Set}}catch(t){return new Set}}(e);n.size;const a=1e4;let i=!1;const c=(new Date).getTime()-26784e5;new Date(c).toISOString().split("T")[0];let d=[],u=[],l=[],_=0,p=s,m=0,f=0,g=!1;const h=Math.ceil(r/3)+2;let w=0;try{for(;d.length<r&&m<h;){d.length;const s=await D(e,t,p,o);if(s.apiError)return{success:!0,posts:d,apiError:!0,errorMessage:s.errorMessage||"Facebook API changed",pageInfo:{total_requests:m,posts_collected:d.length,posts_requested:r,already_scanned_count:f,new_posts_found:u?.length||0,existing_posts_found:l?.length||0,old_posts_skipped:_||0,termination_reason:"api_error",early_termination:!1,database_save_success:!1}};if(!s.success||!s.data)break;const y=U(s.data,e);if(y.length,0===y.length)break;const S=[],I=[];let E=0;for(const e of y){if(!e||!e.id)continue;if(e.createdAt){const t=new Date(e.createdAt).getTime();if(!isNaN(t)&&t<c){_++,E++;continue}}n.has(e.id)?(f++,I.push(e),e.id):(0===f&&S.length<2&&e.id,e.scanOrder=w++,S.push(e),n.add(e.id),!i&&n.size>a&&(n.size,i=!0))}if((S.length>0||E>0)&&(S.length,I.length),u.push(...S),l.push(...I),d.push(...S),f>=2){g=!0;break}m++;const b=s.pageInfo;if(!b?.has_next_page||!b?.end_cursor)break;const v=b.end_cursor;if("string"!=typeof v||v===p)break;p=v,d.length<r&&m<h&&await T(800,2e3)}const s=d.slice(0,r),S=g?"early_termination_duplicates":m>=h?"max_requests_reached":d.length>=r?"target_count_reached":"early_termination_all_scanned";s.length,u.length,l.length,0===u.length&&l.length>0&&l.length;let I=!0;if(u.length>0)try{u.length;const t=u.map(e=>({postId:e.id,scanOrder:e.scanOrder})),s=await async function(e,t){return new Promise(s=>{if("www.facebook.com"!==window.location.hostname)return void chrome.runtime.sendMessage({type:"saveScannedPostIds",postIds:e,groupId:t}).then(e=>{s(e)}).catch(e=>{s({success:!1,error:e.message})});const o=`save_posts_${Date.now()}_${Math.random()}`,r=e=>{"saveScannedPostIdsResponse"===e.data.type&&e.data.requestId===o&&(window.removeEventListener("message",r),s(e.data.result||{success:!0}))};window.addEventListener("message",r),window.parent.postMessage({type:"saveScannedPostIds",postIds:e,groupId:t,requestId:o},"*"),setTimeout(()=>{window.removeEventListener("message",r),s({success:!0,warning:"Coordinator communication timeout but continuing scan"})},1e4)})}(t,e);s&&s.success?t.length:I=!1}catch(y){I=!1}return{success:!0,posts:s,existingPostIds:n,pageInfo:{total_requests:m,posts_collected:s.length,posts_requested:r,already_scanned_count:f,new_posts_found:u.length,existing_posts_found:l.length,old_posts_skipped:_,termination_reason:S,early_termination:S.startsWith("early_termination"),database_save_success:I}}}catch(y){return{success:!1,error:y.message,posts:d,pageInfo:{total_requests:m,posts_collected:d.length,already_scanned_count:f,new_posts_found:u?.length||0,existing_posts_found:l?.length||0,old_posts_skipped:_||0,termination_reason:"error",database_save_success:!1}}}}(r,o,null,{postsPerScan:e});if(!i.success)throw new Error(i.error||"Failed to fetch group feed");const c=[],d=[];for(const o of i.posts){const e=N(o.content,t,s),u={...o,groupName:n,groupUrl:a||`https://www.facebook.com/groups/${r}`,keywords:e,matches:e};if(c.push(u),e.length>0){i.existingPostIds&&i.existingPostIds.has(o.id)?o.id:d.push(u)}}const u={success:!0,posts:c};if(u.success){const e=u.posts.filter(e=>e.matches&&e.matches.length>0);return u.posts.length,e.length,{success:!0,processedCount:u.posts.length,matchedCount:e.length,posts:u.posts,matches:e,groupId:r,groupName:n}}}catch(i){throw i}}(e.data.group,e.data.keywords,e.data.settings);e.source.postMessage({type:"SCAN_RESPONSE",requestId:e.data.requestId,success:!0,processedCount:t.processedCount,matchedCount:t.matchedCount,results:t.matches},e.origin)}catch(t){e.source.postMessage({type:"SCAN_RESPONSE",requestId:e.data.requestId,success:!1,error:t.message},e.origin)}}function R(e,t,s){const o=document.getElementById("title"),r=document.getElementById("message");if(o&&r&&(r.textContent=e,void 0!==t&&void 0!==s)){const e=Math.round(t/s*100);o.textContent=`One Stop Social - Monitoring in Progress (${e}%)`}}function P(){try{let e=window.__req||Math.floor(5*Math.random());const t=e.toString(36),s=Math.random()<.1?2:1;return window.__req=e+s,t}catch(e){return Math.floor(999*Math.random()).toString(36)}}async function T(e=1e3,t=3e3){const s=Math.random()*(t-e)+e;return new Promise(e=>setTimeout(e,s))}function L(e,t){const s=2e3*(e/t);return{min:2e3+s,max:4e3+s}}async function M(){const e=i.enabledGroups,t=i.keywords,s=i.settings||{};if(!e||0===e.length)return{success:!1,error:"No groups available"};if(!t||0===t.length)return{success:!1,error:"No keywords available"};const{positiveKeywords:o,negativeKeywords:r}=A(t);o.length,r.length;let n=0,a=0;const c=[];try{e.length,t.length,i.iframe=await async function(){return new Promise((e,t)=>{document.querySelectorAll('iframe[src*="facebook.com"]').forEach((e,t)=>{e.remove()});const s=document.getElementById("FB_IFRAME_STRATEGY");s&&s.remove();const o=document.createElement("iframe");o.id="FB_IFRAME_STRATEGY",o.src="https://www.facebook.com/",o.style.height="100vh",o.style.width="100vw",o.style.position="absolute",o.style.top="0",o.style.left="0",o.style.zIndex="-1";let r=!1;o.onload=()=>{if(!r){try{const e=o.contentWindow?.location?.href;e&&e.includes("fbsbx.com")}catch(t){}r=!0,e(o)}},o.onerror=e=>{r||(r=!0,t(new Error("Failed to load Facebook iframe")))},document.body.appendChild(o),setTimeout(()=>{if(!r)try{o.contentDocument||o.src?(r=!0,e(o)):(r=!0,t(new Error("Iframe load timeout")))}catch(s){r||(r=!0,e(o))}},5e3)})}();let o=0,r=0;const _=[];for(let n=0;n<e.length;n++){const a=e[n];e.length,a.name;try{if(await chrome.runtime.sendMessage({type:"saveScanProgress",groupId:a.id,groupIndex:n,totalGroups:e.length}),window.location.pathname.includes("scan.html")){const e="This window will close automatically when monitoring is complete.",t=document.getElementById("message");t&&(t.textContent=e)}const i=await O({type:"SCAN_SINGLE_GROUP",group:a,keywords:t,settings:s});if(i.success){o+=i.processedCount||0,r+=i.matchedCount||0,i.results&&_.push(...i.results);try{await chrome.runtime.sendMessage({type:"updateGroupScanStats",groupId:a.id,scannedCount:i.processedCount||0}),a.name}catch(d){a.name}}if(n<e.length-1){const t=L(n,e.length);Math.round(t.min/1e3),Math.round(t.max/1e3),await T(t.min,t.max)}}catch(u){a.name}}const p={success:!0,processedCount:o,matchedCount:r,results:_};if(p.success){n=p.processedCount,a=p.matchedCount,c.push(...p.results);try{if(p.results&&p.results.length>0){p.results.length;const e=p.results.map(e=>chrome.runtime.sendMessage({type:"savePost",post:e}));await Promise.all(e),p.results.length}}catch(l){}i.totalProcessed=n,i.totalMatches=a}return await async function(e){try{if(await new Promise(e=>setTimeout(e,500)),await chrome.runtime.sendMessage({type:"scanCompleted",scanId:Date.now().toString(),results:{totalMatches:e.totalMatches,totalProcessed:e.totalProcessed,groupsScanned:e.groupsScanned,timestamp:Date.now(),scanType:"anti-bot-iframe"}}),window.location.pathname.includes("scan.html")){const e=document.getElementById("message"),t=document.getElementById("title");e&&t&&(t.textContent="Scan Complete!",e.textContent="Closing window..."),setTimeout(()=>{window.close&&window.close()},3e3)}i.iframe&&(i.iframe.remove(),i.iframe=null)}catch(u){}}({totalProcessed:n,totalMatches:a,groupsScanned:p.success?e.length:0,results:c}),{success:!0,totalProcessed:n,totalMatches:a,results:c}}catch(u){return{success:!1,error:u.message,totalProcessed:n,totalMatches:a}}}async function O(e){return new Promise((t,s)=>{const o="scan_"+Date.now()+"_"+Math.random().toString(36).substr(2,9),r=setTimeout(()=>{window.removeEventListener("message",n),s(new Error("Iframe scan timeout - no response from Facebook iframe"))},12e4),n=e=>{"https://www.facebook.com"===e.origin&&"SCAN_RESPONSE"===e.data.type&&e.data.requestId===o&&(clearTimeout(r),window.removeEventListener("message",n),e.data,t(e.data))};window.addEventListener("message",n);const a={...e,requestId:o};a.type,i.iframe.contentWindow.postMessage(a,"https://www.facebook.com")})}function A(e){const t=[],s=[];for(const o of e)"object"==typeof o&&!1===o.isPositive?s.push(o):t.push(o);return{positiveKeywords:t,negativeKeywords:s}}function N(e,t,s={}){if(!e||!t||0===t.length)return[];const{positiveKeywords:o,negativeKeywords:r}=A(t);return function(e,t,s,o={}){if(!e||!t?.length&&!s?.length)return[];const r=e.toLowerCase(),n=o.keywordMatchType||"includes";for(const i of s){const t=("string"==typeof i?i:i.keyword||i.term||String(i)).toLowerCase().trim();if(!t)continue;let s=!1;if("exact"===n){const o=t.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");s=new RegExp(`\\b${o}\\b`,"i").test(e)}else s=r.includes(t);if(s)return[]}const a=[];for(const i of t){const t="string"==typeof i?i:i.keyword||i.term||String(i),s=t.toLowerCase().trim();if(!s)continue;let o=!1;if("exact"===n){const t=s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");o=new RegExp(`\\b${t}\\b`,"i").test(e)}else o=r.includes(s);o&&a.push(t)}return a}(e,o,r,s)}async function D(e,t,s=null,o={}){try{const o={UFI2CommentsProvider_commentsKey:"GroupsCometFeedRegularStoriesPaginationQuery",count:3,cursor:s,displayCommentsContextEnableComment:null,displayCommentsContextIsAdPreview:null,displayCommentsContextIsAggregatedShare:null,displayCommentsContextIsStorySet:null,displayCommentsFeedbackContext:null,feedLocation:"GROUP",feedType:"DISCUSSION",feedbackSource:0,focusCommentID:null,privacySelectorRenderLocation:"COMET_STREAM",renderLocation:"group",scale:1.5,sortingSetting:"CHRONOLOGICAL",stream_initial_count:1,useDefaultActor:!1,id:e,__relay_internal__pv__GroupsCometDelayCheckBlockedUsersrelayprovider:!1,__relay_internal__pv__IsWorkUserrelayprovider:!1,__relay_internal__pv__IsMergQAPollsrelayprovider:!1,__relay_internal__pv__StoriesArmadilloReplyEnabledrelayprovider:!1,__relay_internal__pv__StoriesRingrelayprovider:!1},r=function(){const e=y(),t=Date.now();return{__hs:e.__hs||`${Math.floor(t/1e5)}.HYP:comet_pkg.${Math.floor(10*Math.random())}.1...0`,__rev:(1023e6+Math.floor(1e6*Math.random())).toString(),__hsi:e.__hsi||t.toString()+Math.floor(1e6*Math.random()),__spin_r:(1023e6+Math.floor(1e6*Math.random())).toString(),__spin_b:Math.random()<.8?"trunk":"main",__spin_t:Math.floor(t/1e3).toString()}}(),n=(t.lsd,{_a:"1",__a:"1",__comet_req:"15",__ccg:"EXCELLENT",fb_dtsg:t.fb_dtsg,fb_api_caller_class:"RelayModern",fb_api_req_friendly_name:"GroupsCometFeedRegularStoriesPaginationQuery",variables:JSON.stringify(o),server_timestamps:"true",doc_id:"9676029979119638",__s:E(),av:t.userId,__user:t.userId,__req:P(),lsd:t.lsd,jazoest:w().toString(),__dyn:S(),__csr:I(),...r}),a=(new URLSearchParams(n).toString(),await async function({variables:e,doc_id:t,fb_dtsg:s,additionalData:o={}}){let r;try{const c=await async function(){try{if(window[p])return window[p];const e=m;return window[p]=e,e}catch(e){return window[p]=m,m}}(),d=await async function(){try{return(await b()).userId||""}catch(e){return""}}();let u=await fetch("https://www.facebook.com/api/graphql/",{method:"POST",headers:{"content-type":"application/x-www-form-urlencoded","viewport-width":"951","x-fb-friendly-name":o.fb_api_req_friendly_name||"CometGroupDiscussionRootSuccessQuery","x-fb-lsd":h(),...c?.header||{}},body:z({_a:1,__a:1,__comet_req:15,__ccg:"EXCELLENT",fb_dtsg:s,fb_api_caller_class:"RelayModern",fb_api_req_friendly_name:"CometGroupDiscussionRootSuccessQuery",variables:JSON.stringify(e),server_timestamps:"true",doc_id:t,__s:X(),av:d,__user:d,__req:J(),lsd:h(),jazoest:w(),...y(),...c?.body||{},__dyn:S(),__csr:I(),...o})}),l=await u.text(),_=0;if(r=l,!u.ok)throw new Error(`Facebook GraphQL request failed with ${u.status}`);try{let e=JSON.parse(l);return r=e,e}catch(a){try{l=l.split("\n");var n=[];return l.forEach(e=>{try{n.push(JSON.parse(e))}catch(t){_++}}),r=n,n}catch(i){if(_>0)return l;throw new Error(`JSON parse error: ${i.message}`)}}}catch(a){throw a}}({variables:o,doc_id:"9676029979119638",fb_dtsg:t.fb_dtsg,additionalData:{fb_api_req_friendly_name:"GroupsCometFeedRegularStoriesPaginationQuery"}}));return{success:!0,data:a,pageInfo:q(a)}}catch(r){const e=r.message||r.toString();return e.includes("missing_required_variable_value")||e.includes("Unknown document")||e.includes("doc_id")||e.includes("TypeError")||e.includes("Failed to fetch")||e.includes("NetworkError")||e.includes("ERR_NETWORK")||e.includes("ERR_INTERNET_DISCONNECTED")||e.includes("Request failed")||e.includes("GraphQL request failed")?{success:!0,data:null,pageInfo:{has_next_page:!1,end_cursor:null},apiError:!0,errorMessage:"Facebook GraphQL API changed - please check for updates"}:{success:!1,error:r.message,data:null,pageInfo:{has_next_page:!1,end_cursor:null}}}}function q(e){try{const t=Array.isArray(e)?e:[e];for(const e of t){const t=[e?.data?.node?.group_feed?.page_info,e?.data?.page_info,e?.page_info,e?.data?.node?.timeline?.timeline_feed_units?.page_info,e?.data?.node?.feed?.page_info];for(const e of t)if(e&&"object"==typeof e)return e.has_next_page,e.end_cursor,{has_next_page:e.has_next_page||!1,end_cursor:e.end_cursor||null}}return{has_next_page:!1,end_cursor:null}}catch(t){return{has_next_page:!1,end_cursor:null}}}function U(e,t=null){try{const s=[],o=Array.isArray(e)?e:[e];for(let e=0;e<o.length;e++){const r=o[e];if(r?.data){const o=[r?.data?.node?.group_feed?.edges,r?.data?.node?.timeline?.timeline_feed_units?.edges,r?.data?.node?.feed?.edges,r?.data?.group_feed?.edges,r?.edges,r?.data?.edges,r?.data?.node?.timeline_list_feed_units?.edges,r?.data?.node?.feed_stories?.edges,r?.data?.viewer?.group_feed?.edges,r?.data?.group?.group_feed?.edges,r?.data?.node?.group_feed_stream?.edges];let n=[],a="none";for(let e=0;e<o.length;e++)if(o[e]&&Array.isArray(o[e])&&o[e].length>0){n=o[e],a=`path_${e}`;break}for(let r=0;r<n.length;r++){const o=n[r],a=o?.node;if(!a)continue;const i=Q(a,e+1,r,t);i&&s.push(i)}if(r.data.node&&"Story"===r.data.node.__typename){const o=Q(r.data.node,e+1,"individual",t);o&&s.push(o)}else if(r.data.node&&!r.data.node.__typename&&0===n.length){const o=r.data.node;Object.keys(o);const n=F(o);if(n){n.substring(0,100);const r=Q(o,e+1,"unmarked",t);r&&s.push(r)}}else if(r.data.node&&0===n.length){const o=r.data.node;if(o.__typename,Object.keys(o),!o.__typename||!o.__typename.includes("Header")&&!o.__typename.includes("Ads")){const r=Q(o,e+1,"fallback",t);r&&(s.push(r),r.content?.substring(0,50))}}}else if(r?.node){const o=r.node;if(o&&"object"==typeof o){o.__typename,Object.keys(o).join(", ");const r=Q(o,e+1,"direct",t);r&&(s.push(r),r.content?.substring(0,50))}}}return s.length,s}catch(s){return[]}}function x(e,t,s,o=4,r=0){if(r>=o||!e||"object"!=typeof e)return null;for(const[n,a]of Object.entries(e)){if(n===t&&a&&"object"==typeof a&&a[s])return a[s];if("object"==typeof a&&null!==a){const e=x(a,t,s,o,r+1);if(e)return e}}return null}function G(e,t=3,s=0){if(s>=t||!e||"object"!=typeof e)return"";let o=[];for(const[r,n]of Object.entries(e))if("text"===r&&"string"==typeof n&&n.trim().length>5)o.push(n.trim());else if("object"==typeof n&&null!==n){const e=G(n,t,s+1);e&&o.push(e)}return o.filter(e=>e.length>5).join(" ").substring(0,500)}function F(e){if(!e)return null;const t=[e.message?.text,e.comet_sections?.message?.story?.message?.text,e.comet_sections?.content?.story?.comet_sections?.message?.story?.message?.text,e.attached_story?.comet_sections?.content?.story?.comet_sections?.message?.story?.message?.text,e.attached_story?.comet_sections?.message?.story?.message?.text,e.comet_sections?.content?.story?.message?.text,e.attached_story?.message?.text,e.content?.story?.message?.text,e.story?.message?.text,x(e,"message","text"),e.comet_sections?.attachments?.[0]?.styles?.attachment?.title_with_entities?.text,e.attached_story?.comet_sections?.attachments?.[0]?.styles?.attachment?.title_with_entities?.text,e.comet_sections?.content?.story?.comet_sections?.content?.story?.message?.text];for(const o of t)if(o&&"string"==typeof o&&o.trim())return o.trim();const s=G(e);return s&&s.length>10?s.substring(0,1e3):null}function $(e){if(!e)return null;const t=[e.actors?.[0]?.name,e.actor?.name,e.comet_sections?.actor_photo?.story?.actors?.[0]?.name,e.attached_story?.comet_sections?.context_layout?.story?.comet_sections?.actor_photo?.story?.actors?.[0]?.name,e.attached_story?.comet_sections?.actor_photo?.story?.actors?.[0]?.name];for(const s of t)if(s&&"string"==typeof s&&s.trim())return s.trim();return null}function j(e,t=5,s=0){const o=[];if(s>=t||!e||"object"!=typeof e)return o;for(const[r,n]of Object.entries(e))if("number"==typeof n&&(r.toLowerCase().includes("time")||r.toLowerCase().includes("created")||r.toLowerCase().includes("published"))&&n>1e9&&n<9999999999&&o.push(n),"object"==typeof n&&null!==n){const e=j(n,t,s+1);o.push(...e)}return o}function B(e){if(!e)return null;const t=["created_time","creation_time","timestamp","published_time","time"];for(const o of t)if(e[o]&&"number"==typeof e[o])return 1e3*e[o];const s=j(e);return s.length>0?1e3*s[0]:null}function H(e){if(!e)return null;try{const t=["id","post_id","story_id","legacy_story_hideable_token","legacy_api_story_id","legacy_api_post_id","story_fbid","post_fbid","fbid","attached_story.id","attached_story.post_id","attached_story.story_id","comet_sections.context.story.id","comet_sections.header.story.id","comet_sections.attribution.story.id"];for(const s of t){let t;if(s.includes(".")){const o=s.split(".");t=e;for(const e of o)if(t=t?.[e],!t)break}else t=e[s];if(t&&"string"==typeof t&&t.trim())return t.trim()}return Object.keys(e),null}catch(t){return t.message,null}}function K(e,t){if(!e)return null;try{const s=[e.url,e.permalink_url,e.attached_story?.url,e.attached_story?.permalink_url,e.story?.url,e.story?.permalink_url,e.share_link,e.permalink,e.comet_sections?.context?.story?.url,e.comet_sections?.header?.story?.url,e.comet_sections?.attribution?.story?.url,e.wwwURL,e.attached_story?.wwwURL,e.legacy_api_story_id,e.legacy_story_hideable_token];for(let e=0;e<s.length;e++){const t=s[e];if(t&&"string"==typeof t&&t.startsWith("http")){const s=["url","permalink_url","attached_story.url","attached_story.permalink_url","story.url","story.permalink_url","share_link","permalink","comet_sections.context.story.url","comet_sections.header.story.url","comet_sections.attribution.story.url","wwwURL","attached_story.wwwURL","legacy_api_story_id","legacy_story_hideable_token"][e];return window.FB_URL_SUCCESS_STATS||(window.FB_URL_SUCCESS_STATS={}),window.FB_URL_SUCCESS_STATS[s]=(window.FB_URL_SUCCESS_STATS[s]||0)+1,t}}const o=H(e);if(o&&t){const e=`https://www.facebook.com/groups/${t}/posts/${o}`;return window.FB_URL_SUCCESS_STATS||(window.FB_URL_SUCCESS_STATS={}),window.FB_URL_SUCCESS_STATS.constructed_group_url=(window.FB_URL_SUCCESS_STATS.constructed_group_url||0)+1,e}if(o){const e=`https://www.facebook.com/story.php?story_fbid=${o}`;return window.FB_URL_SUCCESS_STATS||(window.FB_URL_SUCCESS_STATS={}),window.FB_URL_SUCCESS_STATS.constructed_generic_url=(window.FB_URL_SUCCESS_STATS.constructed_generic_url||0)+1,e}return null}catch(s){return s.message,null}}function W(e,t){if(!e)return null;try{const s=K(e,t);if(s&&!s.includes("UzpfS"))return s;const o=H(e);if(o&&o.startsWith("UzpfS")){const e=function(e){try{if(!e||"string"!=typeof e)return null;let t=e;for(;t.length%4;)t+="=";const s=atob(t),o=s.match(/VK:(\d+)/);if(o)return o[1];const r=s.match(/(\d+)/);if(r){return r[1]}return null}catch(t){return null}}(o);if(e&&t){const s=[`https://www.facebook.com/groups/${t}/posts/${e}`,`https://www.facebook.com/groups/${t}/permalink/${e}`,`https://facebook.com/groups/${t}/posts/${e}`,`https://www.facebook.com/story.php?story_fbid=${e}&id=${t}`,`https://www.facebook.com/groups/${t}/?p=${e}`,`https://m.facebook.com/groups/${t}/posts/${e}`][0];return window.FB_URL_SUCCESS_STATS||(window.FB_URL_SUCCESS_STATS={}),window.FB_URL_SUCCESS_STATS.decoded_group_url=(window.FB_URL_SUCCESS_STATS.decoded_group_url||0)+1,s}}return s}catch(s){return K(e,t)}}function Q(e,t,s,o=null){if(!e)return null;if(e.__typename,"GroupsSectionHeaderUnit"===e.__typename||"GroupsSelectionHeaderUnit"===e.__typename||"FeedAdsUnit"===e.__typename)return e.__typename,null;e.__typename&&e.__typename,!e.__typename&&(e.message||e.comet_sections||e.attached_story);const r=F(e),n=$(e),a=B(e),i=H(e),c=W(e,o),d=function(e){const t={name:"",profile_url:"",profile_pic_url:""};try{if(t.name=$(e)||"",e.actors&&Array.isArray(e.actors)&&e.actors.length>0){const s=e.actors[0];s.url&&"string"==typeof s.url&&(t.profile_url=s.url,s.url)}return t.profile_pic_url=function(e){try{try{const t=e.comet_sections?.context_layout?.story?.comet_sections;if(t?.actor_photo?.story?.actors?.[0]){const e=t.actor_photo.story.actors[0];e.name;const s=[e.profile_picture?.uri,e.profile_picture_depth_0?.uri,e.profilePicture?.uri,e.profile_pic?.uri];for(const t of s)if(t&&"string"==typeof t&&t.startsWith("http"))return t}}catch(t){t.message}try{const t=e.comet_sections?.actor_photo?.story?.actors?.[0];if(t){t.name;const e=[t.profile_picture?.uri,t.profile_picture_depth_0?.uri,t.profilePicture?.uri,t.profile_pic?.uri];for(const t of e)if(t&&"string"==typeof t&&t.startsWith("http"))return t.substring(0,50),t}}catch(t){t.message}try{if(e.actors&&e.actors.length>0){const t=e.actors[0];t.name;const s=[t.profile_picture?.uri,t.profile_picture_depth_0?.uri,t.profilePicture?.uri,t.profile_pic?.uri];for(const e of s)if(e&&"string"==typeof e&&e.startsWith("http"))return e.substring(0,50),e}}catch(t){t.message}return null}catch(s){return null}}(e),t}catch(s){return t}}(e),u=function(e){try{const s=[()=>e.feedback?.reactors?.count,()=>e.feedback?.likers?.count,()=>e.feedback?.reactions_count,()=>e.feedback?.like_count,()=>e.reactions?.count,()=>e.like_count,()=>e.reaction_count,()=>e.comet_sections?.feedback?.story?.feedback?.reactors?.count,()=>e.comet_sections?.feedback?.story?.feedback?.likers?.count];for(const e of s)try{const t=e();if("number"==typeof t&&t>=0)return t}catch(t){}return 0}catch(t){return 0}}(e);if(r){let e;try{if(a&&"number"==typeof a){e=new Date(a>1e12?a:1e3*a)}else e=new Date;isNaN(e.getTime())&&(e=new Date)}catch(l){e=new Date}return{provider:"facebook",id:`facebook_${i||`feed_${Date.now()}_${t}_${s}`}`,url:c||"",authorName:d.name||n||"Unknown",authorProfileUrl:d.profile_url||"",authorProfilePicture:d.profile_pic_url||"",content:r,keywords:[],likes:u,postedAt:e.toISOString(),createdAt:e.toISOString(),scanType:"group_feed",found_at:Date.now(),groupId:null,groupName:null,timestamp:e.getTime(),author:{name:d.name||n||"Unknown",profile_url:d.profile_url||"",profile_pic_url:d.profile_pic_url||""},avatarUrl:d.profile_pic_url||""}}return e.__typename,null}function z(e){try{const t=new URLSearchParams;for(const[s,o]of Object.entries(e))null==o?t.append(s,""):"object"==typeof o?t.append(s,JSON.stringify(o)):t.append(s,String(o));return t.toString()}catch(t){return new URLSearchParams(e).toString()}}function J(){return P()}function X(){return E()}window.addEventListener("message",async e=>{if(e.origin===window.location.origin||e.origin.startsWith("chrome-extension://")||e.origin.startsWith("file://")||"https://www.facebook.com"===e.origin){switch(e.data&&e.data.type&&(e.data.type.startsWith("GET_FACEBOOK")||e.data.type.startsWith("GRAPHQL")||e.data.type.startsWith("FETCH_USER")||"PING"===e.data.type||e.data.type.startsWith("SCAN_")||"performScan"===e.data.type||e.data.type.includes("ScannedPostIds")||e.data.type),e.data.type){case"GET_FACEBOOK_TOKENS":await async function(e){try{const t=await b();Object.keys(t||{}),e.source.postMessage({type:"FACEBOOK_TOKENS_RESPONSE",requestId:e.data.requestId,tokens:t},e.origin)}catch(t){e.source.postMessage({type:"FACEBOOK_TOKENS_RESPONSE",requestId:e.data.requestId,error:t.message},e.origin)}}(e);break;case"GET_USER_PROFILE":await C(e);break;case"FETCH_USER_GROUPS":await async function(e){try{const t=await b(),s=await v(t);if(!(s&&s.success&&s.groups))throw new Error("Failed to fetch groups");e.source.postMessage({type:"USER_GROUPS_RESPONSE",requestId:e.data.requestId,groups:s.groups},e.origin)}catch(t){e.source.postMessage({type:"USER_GROUPS_RESPONSE",requestId:e.data.requestId,error:t.message},e.origin)}}(e);break;case"GRAPHQL_REQUEST":await async function(e){try{const t=await Q(e.data.variables,e.data.doc_id);e.source.postMessage({type:"GRAPHQL_REQUEST_RESPONSE",requestId:e.data.requestId,result:t},e.origin)}catch(t){e.source.postMessage({type:"GRAPHQL_REQUEST_RESPONSE",requestId:e.data.requestId,error:t.message},e.origin)}}(e);break;case"PING":!function(e){e.source.postMessage({type:"PONG",requestId:e.data.requestId,timestamp:Date.now()},e.origin)}(e);break;case"SCAN_SINGLE_GROUP":await k(e);break;case"SCAN_ALL_GROUPS":await async function(e){try{const t=await M(e.data.groups,e.data.keywords,e.data.settings);e.source.postMessage({type:"SCAN_ALL_GROUPS_RESPONSE",requestId:e.data.requestId,result:t},e.origin)}catch(t){e.source.postMessage({type:"SCAN_ALL_GROUPS_RESPONSE",requestId:e.data.requestId,error:t.message},e.origin)}}(e);break;case"getScannedPostIds":await async function(e){e.data.requestId,e.data.groupId;try{chrome&&chrome.runtime&&chrome.runtime.sendMessage?chrome.runtime.sendMessage({type:"getScannedPostIds",groupId:e.data.groupId},t=>{chrome.runtime.lastError?(chrome.runtime.lastError.message,e.source.postMessage({type:"scannedPostIdsResponse",requestId:e.data.requestId,result:{success:!1,error:chrome.runtime.lastError.message}},e.origin)):(e.data.requestId,e.source.postMessage({type:"scannedPostIdsResponse",requestId:e.data.requestId,result:t||{success:!1,error:"No response from background"}},e.origin))}):e.source.postMessage({type:"scannedPostIdsResponse",requestId:e.data.requestId,result:{success:!1,error:"Chrome runtime not available"}},e.origin)}catch(t){e.source.postMessage({type:"scannedPostIdsResponse",requestId:e.data.requestId,result:{success:!1,error:t.message}},e.origin)}}(e);break;case"saveScannedPostIds":await async function(e){e.data.requestId,e.data.groupId,e.data.postIds;try{if(chrome&&chrome.runtime&&chrome.runtime.sendMessage){let t=setTimeout(()=>{e.source.postMessage({type:"saveScannedPostIdsResponse",requestId:e.data.requestId,result:{success:!0,message:"Save request sent (timeout)"}},e.origin)},2e3);chrome.runtime.sendMessage({type:"saveScannedPostIds",postIds:e.data.postIds,groupId:e.data.groupId},s=>{clearTimeout(t),chrome.runtime.lastError?(chrome.runtime.lastError.message,e.source.postMessage({type:"saveScannedPostIdsResponse",requestId:e.data.requestId,result:{success:!0,message:"Save attempted despite error"}},e.origin)):(e.data.requestId,e.source.postMessage({type:"saveScannedPostIdsResponse",requestId:e.data.requestId,result:s||{success:!0,message:"Save completed"}},e.origin))})}else e.source.postMessage({type:"saveScannedPostIdsResponse",requestId:e.data.requestId,result:{success:!0,message:"Chrome runtime not available"}},e.origin)}catch(t){e.source.postMessage({type:"saveScannedPostIdsResponse",requestId:e.data.requestId,result:{success:!0,message:"Save attempted despite error"}},e.origin)}}(e);break;case"CHECK_POST_IN_DATABASE":await async function(e){e.data.requestId,e.data.postId;try{chrome&&chrome.runtime&&chrome.runtime.sendMessage?chrome.runtime.sendMessage({type:"checkPostInDatabase",postId:e.data.postId,groupId:e.data.groupId},t=>{chrome.runtime.lastError?(chrome.runtime.lastError.message,e.source.postMessage({type:"CHECK_POST_RESPONSE",requestId:e.data.requestId,exists:!1},e.origin)):e.source.postMessage({type:"CHECK_POST_RESPONSE",requestId:e.data.requestId,exists:t?.exists||!1},e.origin)}):e.source.postMessage({type:"CHECK_POST_RESPONSE",requestId:e.data.requestId,exists:!1},e.origin)}catch(t){e.source.postMessage({type:"CHECK_POST_RESPONSE",requestId:e.data.requestId,exists:!1},e.origin)}}(e);break;case"GET_ALL_SCANNED_POST_IDS":await async function(e){e.data.requestId,e.data.groupId;try{chrome&&chrome.runtime&&chrome.runtime.sendMessage?chrome.runtime.sendMessage({type:"getAllScannedPostIds",groupId:e.data.groupId},t=>{chrome.runtime.lastError?(chrome.runtime.lastError.message,e.source.postMessage({type:"GET_ALL_SCANNED_POST_IDS_RESPONSE",requestId:e.data.requestId,postIds:[]},e.origin)):e.source.postMessage({type:"GET_ALL_SCANNED_POST_IDS_RESPONSE",requestId:e.data.requestId,postIds:t?.postIds||[]},e.origin)}):e.source.postMessage({type:"GET_ALL_SCANNED_POST_IDS_RESPONSE",requestId:e.data.requestId,postIds:[]},e.origin)}catch(t){e.source.postMessage({type:"GET_ALL_SCANNED_POST_IDS_RESPONSE",requestId:e.data.requestId,postIds:[]},e.origin)}}(e);break;case"scannedPostIdsResponse":case"saveScannedPostIdsResponse":case"GET_ALL_SCANNED_POST_IDS_RESPONSE":case"SCAN_RESPONSE":case"SCAN_SINGLE_GROUP_RESPONSE":case"CHECK_POST_RESPONSE":case"FROM_INJECTOR_SCRIPT":break;default:e.data.type&&e.data.type}if("updateGroupScanStats"===e.data.type&&(e.data,chrome&&chrome.runtime&&chrome.runtime.sendMessage))try{chrome.runtime.sendMessage({type:"updateGroupScanStats",groupId:e.data.groupId,scannedCount:e.data.scannedCount}),e.data.groupId}catch(t){}}}),window.addEventListener("message",async e=>{e.origin.includes("chrome-extension://")}),"undefined"!=typeof chrome&&chrome.runtime&&chrome.runtime.onMessage&&"function"==typeof chrome.runtime.onMessage.addListener&&chrome.runtime.onMessage.addListener((e,t,s)=>{if("ping"===e.type)return s({success:!0,ready:!0}),!0;if("COORDINATE_SCAN_ALL"===e.type)return(async()=>{try{if(e.isDemoMode){R("Starting demo scan...",0,1);const t=await async function(e,t){e.length,t.length;try{const s=await fetch(chrome.runtime.getURL("demo-data.json")),o=await s.json();let r=0,n=0;const a=Date.now();for(let c=0;c<e.length;c++){const s=e[c];R(`Scanning ${s.name}...`,c,e.length);const a=o.posts.filter(e=>e.groupId===s.id);a.length,s.name;const i=[];for(const e of a){r++;const s=[];for(const o of t)o.isPositive&&e.content.toLowerCase().includes(o.term.toLowerCase())&&s.push(o.term);if(s.length>0){const t={...e,keywords:s,authorName:e.author,author:{name:e.author}};i.push(t),n++,e.id}}i.length>0&&chrome.runtime.sendMessage({type:"postsScanned",groupId:s.id,posts:i,scannedCount:a.length}),chrome.runtime.sendMessage({type:"scanStatsUpdated",groupId:s.id,scannedCount:a.length}),await new Promise(e=>setTimeout(e,2e3))}R("Demo scan complete!",e.length,e.length);const i=Date.now()-a;return chrome.runtime.sendMessage({type:"scanCompleted",scanId:`demo_scan_${Date.now()}`,results:{totalProcessed:r,totalMatches:n,groupsScanned:e.length,duration:i}}),setTimeout(()=>{window.close()},2e3),{success:!0,totalProcessed:r,totalMatches:n}}catch(s){throw R("Demo scan failed: "+s.message,0,1),s}}(e.enabledGroups,e.keywords);s({success:!0,completed:!0,result:t})}else{e.keywords&&(a=e.keywords),i.enabledGroups=e.enabledGroups||[],i.keywords=e.keywords||[],i.settings=e.settings||{};const t=await M();s({success:!0,completed:!0,result:t})}}catch(t){s({success:!1,error:t.message})}})(),!0;if("fetchAllGroups"===e.type)return(async()=>{try{const e=b(),t=await v(e);s({success:!0,completed:!0,result:t})}catch(e){s({success:!1,error:e.message})}})(),!0;if("scanCompleted"===e.type)return!0;if("extractDynamicValues"===e.type||"getFacebookTokens"===e.type){const e=b();return s({success:!0,...e}),!0}}),window.addEventListener("unload",()=>{i.iframe&&(i.iframe.remove(),i.iframe=null);document.querySelectorAll('iframe[src*="facebook.com"]').forEach(e=>{"FB_IFRAME_STRATEGY"===e.id&&e.remove()})});
