const e={DEBUG:0,INFO:1,WARN:2,ERROR:3},t="SYSTEM",n="HIGH",o="MEDIUM";class s{constructor(t,n=e.INFO){this.component=t,this.minLevel=n,this.errorCount=0;try{this.isDev=chrome.runtime.getManifest().version_name?.includes("dev"),this.isProduction=!this.isDev}catch(o){this.isDev=!1,this.isProduction=!0}}log(t,n,o=null){if(t<this.minLevel)return;if(this.isProduction&&t<e.WARN)return;const s=Object.keys(e).find(n=>e[n]===t);(new Date).toISOString().substr(11,12),this.component}debug(t,n){this.log(e.DEBUG,t,n)}info(t,n){this.log(e.INFO,t,n)}warn(t,n){this.log(e.WARN,t,n)}error(t,n){this.errorCount++,this.log(e.ERROR,t,n)}logError(t,n,o,s=null,a={}){if(this.errorCount++,this.isProduction)this.log(e.ERROR,`[${t}][${n}] ${o}`);else{const i={category:t,severity:n,error:s?{message:s.message,stack:s.stack}:null,context:a,timestamp:(new Date).toISOString()};this.log(e.ERROR,`[${t}][${n}] ${o}`,i)}}}const a=new s("UI"),i=new s("Database");new s("Validation");const r=new s("Sync");class c{static withTimeout(e,t,n="operation"){return Promise.race([e,new Promise((e,o)=>setTimeout(()=>o(new Error(`${n} timed out after ${t}ms`)),t))])}static async withRetry(e,o=3,s=1e3,a="operation"){for(let c=1;c<=o;c++)try{return await e()}catch(i){const e=c===o,d=this.isRetryableError(i);if(e||!d)throw r.logError(t,n,`${a} failed after ${c} attempts`,i,{maxRetries:o,attempt:c}),i;r.warn(`${a} failed on attempt ${c}, retrying in ${s}ms`,{error:i.message}),await this.delay(s*c)}}static isRetryableError(e){const t=e.message?.toLowerCase()||"";return t.includes("timeout")||t.includes("network")||t.includes("connection")||t.includes("rate limit")||"TimeoutError"===e.name}static delay(e){return new Promise(t=>setTimeout(t,e))}static async safeAsync(e,n=null,s={}){try{return await e()}catch(a){return r.logError(t,o,"Safe async operation failed, using fallback",a,s),n}}}const d=new class{constructor(){this.timers=new Map,this.metrics=[]}start(e){const t=`${e}_${Date.now()}`;return this.timers.set(t,{operation:e,startTime:performance.now()}),t}end(e,t=!0){if(!this.timers.has(e))return null;const n=this.timers.get(e),o=performance.now()-n.startTime,s={operation:n.operation,duration:o,success:t,timestamp:Date.now()};return this.metrics.push(s),this.timers.delete(e),this.metrics.length>100&&this.metrics.shift(),o>100&&a.warn(`Slow UI operation: ${n.operation} took ${o.toFixed(2)}ms`),s}async timeAsync(e,t){const n=this.start(e);try{const e=await t();return this.end(n,!0),e}catch(o){throw this.end(n,!1),o}}getStats(){const e=this.metrics.slice(-50);if(0===e.length)return null;const t=e.reduce((e,t)=>e+t.duration,0)/e.length,n=Math.max(...e.map(e=>e.duration)),o=e.filter(e=>e.success).length/e.length;return{totalOperations:e.length,avgDuration:t.toFixed(2)+"ms",maxDuration:n.toFixed(2)+"ms",successRate:(100*o).toFixed(1)+"%"}}},l="fb_keyword_monitor",u=2;let g=null,m="all",p="newest",y=1,h=10,f=[],w=[],b=[],v="",k=!1,E=null,L="lastVisited",S="desc",I=!1,x=0;let T=!1,$={isSignedIn:!1,firstName:"",fullName:"",profilePicture:"",userId:""},M=!1,N=null,P=null,B=0,A={};let C={data:null,timestamp:0,ttl:3e5},F=!1,H=0;async function R(){const e=Date.now();if(P&&e-B<36e5)return a.debug(` Using cached groups data (${P.length} groups)`),P;a.debug("Groups cache expired or missing, fetching fresh data");const t=await De();return P=t,B=e,A={},t.forEach(e=>{A[e.id]=e.name}),a.debug(` Groups cache updated with ${t.length} groups`),t}function q(){a.debug("Invalidating groups cache"),P=null,B=0,A={}}async function D(){return new Promise((e,t)=>{const n=indexedDB.open(l,u);n.onupgradeneeded=e=>{const t=e.target.result;if(!t.objectStoreNames.contains("groups")){t.createObjectStore("groups",{keyPath:"id",autoIncrement:!1}).createIndex("url","url",{unique:!0})}t.objectStoreNames.contains("posts")||t.createObjectStore("posts",{keyPath:"id",autoIncrement:!0}),t.objectStoreNames.contains("keywords")||t.createObjectStore("keywords",{keyPath:"id",autoIncrement:!0}),t.objectStoreNames.contains("config")||t.createObjectStore("config",{keyPath:"id",autoIncrement:!0})},n.onsuccess=t=>{g=t.target.result,i.info("Database initialized"),e(g)},n.onerror=e=>{e.target.error,t(e.target.error)}})}const U=document.getElementById("dashboard-page"),O=document.getElementById("settings-page"),_=document.getElementById("keyword-settings"),G=document.getElementById("scan-settings"),j=document.getElementById("keywords-container"),z=document.getElementById("negative-keywords-container"),V=document.getElementById("groups-table-body"),K=document.getElementById("leads-container"),W=document.getElementById("keyword-input"),J=document.getElementById("negative-keyword-input"),Y=document.getElementById("posts-per-scan"),X=document.getElementById("group-count-display"),Q=document.getElementById("run-scan-now-btn"),Z=document.getElementById("last-scan-time");document.querySelectorAll(".nav-item").forEach(e=>{e.addEventListener("click",e=>{e.preventDefault();const t=e.currentTarget.getAttribute("href").substring(1);k=!1,E=null,U.style.display="none",O.style.display="none","dashboard"===t?(U.style.display="block",F=!0,a.debug(" User navigated to dashboard - set hasViewedDashboardSinceNewPosts to true"),he()):"settings"===t&&(O.style.display="block",async function(){if(!j||!z)return;try{const e=await Ce();j.innerHTML="",z.innerHTML="";let t=0,n=0;e.forEach(e=>{const o=function(e){const t=document.createElement("div");t.className=e.isPositive?"keyword-card keyword-card-positive":"keyword-card keyword-card-negative",t.innerHTML=`\n    <div class="keyword-term">${e.term}</div>\n    <div class="keyword-platforms">\n      <div class="platform-icon" title="Verwijderen" data-id="${e.id}">\n        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>\n      </div>\n    </div>\n  `;return t.querySelector(".platform-icon[data-id]").onclick=async()=>{try{await Ae(e.id),t.remove(),U&&"block"===U.style.display&&Pe()}catch(n){}},t}(e);e.isPositive?(j.appendChild(o),t++):(z.appendChild(o),n++)}),await async function(){const e=document.getElementById("settings-ai-description-input"),t=document.getElementById("save-ai-description-btn");if(!e||!t)return;if("true"===e.dataset.listenersAdded)return;try{const n=await He("aiPostDescription");n&&(e.value=n,e.dataset.originalValue=n);let o=!1;const s=()=>{const n=e.value.trim(),s=e.dataset.originalValue||"";o=n!==s&&n.length>0,t.disabled=!o};e.addEventListener("input",s);const a=async()=>{const n=e.value.trim();if(n){t.disabled=!0,t.textContent="Bezig met opslaan...";try{await Ne({type:"saveAIDescription",description:n}),e.dataset.originalValue=n,showSuccessNotification("Opgeslagen","AI-beschrijving succesvol opgeslagen"),t.textContent="Beschrijving opslaan",t.disabled=!0}catch(o){showErrorNotification("Fout","Kan beschrijving niet opslaan"),t.textContent="Beschrijving opslaan",t.disabled=!1}}else showErrorNotification("Fout","Voer een beschrijving in")};t.addEventListener("click",a),e.dataset.listenersAdded="true"}catch(n){}}()}catch(e){j.innerHTML='<p class="text-danger">Fout bij laden van zoekwoorden.</p>',z.innerHTML='<p class="text-danger">Fout bij laden van zoekwoorden.</p>'}}(),Ve()),document.querySelectorAll(".nav-item").forEach(e=>{e.classList.remove("active")}),e.currentTarget.classList.add("active")})});const ee=document.querySelectorAll("#settings-page > .tabs > .tab"),te=["groups-settings-content","keyword-settings-content","scan-settings-content","notifications-settings-content"];ee.forEach((e,t)=>{e.addEventListener("click",()=>{a.debug(` Settings tab ${t} clicked`),ee.forEach(e=>e.classList.remove("active")),e.classList.add("active"),te.forEach((e,n)=>{const o=document.getElementById(e);o&&(o.style.display=n===t?"block":"none")}),0===t&&Ve(),3===t&&rt()})});const ne=document.querySelectorAll("#settings-page > .card > .tabs > .tab");ne.forEach((e,t)=>{e.addEventListener("click",()=>{ne.forEach(e=>e.classList.remove("active")),e.classList.add("active"),void 0!==_&&void 0!==G&&(0===t?(_.style.display="block",G.style.display="none"):(_.style.display="none",G.style.display="block",Ve()))})});const oe=document.querySelectorAll("#dashboard-page .tabs > .tab");oe.forEach(e=>{e.addEventListener("click",()=>{const t=e.getAttribute("data-filter")||"all";oe.forEach(e=>e.classList.remove("active")),e.classList.add("active"),m=t,y=1,k=!1,E=null;const n=document.getElementById("search-input");n&&(n.value="",v=""),be()})});const se=document.getElementById("edit-keywords-btn");se&&se.addEventListener("click",()=>{const e=document.querySelector('a[href="#settings"]');e&&e.click(),setTimeout(()=>{const e=document.querySelectorAll("#settings-page > .tabs > .tab");e[1]&&e[1].click()},100)});const ae=document.getElementById("edit-groups-btn");ae&&ae.addEventListener("click",()=>{const e=document.querySelector('a[href="#settings"]');e&&e.click(),setTimeout(()=>{const e=document.querySelectorAll("#settings-page > .tabs > .tab");e[0]&&e[0].click()},100)});const ie=document.getElementById("setup-keywords-btn");ie&&ie.addEventListener("click",()=>{const e=document.querySelector('a[href="#settings"]');e&&e.click(),setTimeout(()=>{const e=document.querySelectorAll("#settings-page > .tabs > .tab");e[1]&&e[1].click()},100)});const re=document.getElementById("setup-groups-btn");re&&re.addEventListener("click",()=>{const e=document.querySelector('a[href="#settings"]');e&&e.click(),setTimeout(()=>{const e=document.querySelectorAll("#settings-page > .tabs > .tab");e[0]&&e[0].click()},100)});const ce=document.getElementById("filter-sort-btn"),de=document.getElementById("sort-dropdown-menu");if(ce&&de){ce.addEventListener("click",e=>{e.stopPropagation();de.classList.contains("show")?(de.classList.remove("show"),ce.classList.remove("active")):(de.classList.add("show"),ce.classList.add("active"))});const e=de.querySelectorAll(".sort-dropdown-item");e.forEach(t=>{t.addEventListener("click",n=>{n.stopPropagation();const o=t.getAttribute("data-sort");a.debug(` Sort option selected: ${o}`),p=o,y=1,e.forEach(e=>e.classList.remove("active")),t.classList.add("active"),de.classList.remove("show"),ce.classList.remove("active"),be()})}),document.addEventListener("click",()=>{de.classList.remove("show"),ce.classList.remove("active")});const t=de.querySelector('[data-sort="newest"]');t&&t.classList.add("active")}async function le(){try{const{isDemoMode:e}=await chrome.storage.sync.get("isDemoMode");if(e){a.debug(" Demo mode active - returning demo groups...");const e=await fetch(chrome.runtime.getURL("demo-data.json"));return(await e.json()).groups}a.debug(" Fetching user groups via iframe...");let t=document.querySelector("#FB_GROUP_FETCH_IFRAME");t||(a.debug(" Creating Facebook iframe for group fetching..."),t=document.createElement("iframe"),t.id="FB_GROUP_FETCH_IFRAME",t.src="https://www.facebook.com/",t.style.height="100vh",t.style.width="100vw",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.zIndex="-1",t.style.opacity="0",t.style.pointerEvents="none",document.body.appendChild(t),await new Promise(e=>setTimeout(e,12e3)),a.debug(" Facebook iframe created and content script should be ready (waited 12s)"));const n=await async function(){try{a.debug(" Getting Facebook tokens using iframe approach...");let t=document.querySelector("#FB_GROUP_FETCH_IFRAME");t||(a.debug(" Creating Facebook iframe for tokens..."),t=document.createElement("iframe"),t.id="FB_GROUP_FETCH_IFRAME",t.src="https://www.facebook.com/",t.style.height="100vh",t.style.width="100vw",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.zIndex="-1",t.style.opacity="0",t.style.pointerEvents="none",document.body.appendChild(t),await new Promise(e=>setTimeout(e,12e3)),a.debug(" Facebook iframe created and content script should be ready (waited 12s)")),await new Promise(e=>setTimeout(e,8e3)),a.debug(" Testing iframe communication with PING (with retries)...");const n=3;let o=!1;for(let a=1;a<=n;a++){const s=Date.now().toString();try{await new Promise((e,n)=>{const o=setTimeout(()=>{n(new Error(`PING timeout on attempt ${a} - iframe communication not working`))},8e3),i=t=>{"PONG"===t.data.type&&t.data.requestId===s&&(clearTimeout(o),window.removeEventListener("message",i),e())};window.addEventListener("message",i),t.contentWindow.postMessage({type:"PING",requestId:s},"*")}),o=!0;break}catch(e){if(e.message,a<n){const e=3e3*a;await new Promise(t=>setTimeout(t,e))}}}if(!o)throw new Error(`Iframe communication failed after ${n} attempts - content script may not be loaded`);a.debug(" Requesting tokens from content script...");const s=Date.now().toString();return new Promise((e,n)=>{const o=setTimeout(()=>{n(new Error("Timeout waiting for Facebook tokens (increased to 25s)"))},25e3),i=t=>{if("FACEBOOK_TOKENS_RESPONSE"===t.data.type&&t.data.requestId===s){clearTimeout(o),window.removeEventListener("message",i),a.debug(" Received tokens from content script");const s=t.data.tokens;s.error?n(new Error(`Content script error: ${s.error}`)):s.fb_dtsg?(a.debug(" Successfully got tokens:",{fb_dtsg:s.fb_dtsg?"Found":"Missing",userId:s.userId?"Found":"Missing",lsd:s.lsd?"Found":"Missing"}),H=0,e(s)):n(new Error("No fb_dtsg token received from content script"))}};window.addEventListener("message",i),t.contentWindow.postMessage({type:"GET_FACEBOOK_TOKENS",requestId:s},"*")})}catch(e){H++;throw new Error(`Token extraction failed: ${e.message}. Please ensure you're logged into Facebook.`)}}();a.debug(" Got tokens, requesting groups from content script...");const o=Date.now().toString();return new Promise((e,s)=>{const i=setTimeout(()=>{s(new Error("Timeout waiting for groups (increased to 45s)"))},45e3),r=t=>{"USER_GROUPS_RESPONSE"===t.data.type&&t.data.requestId===o&&(clearTimeout(i),window.removeEventListener("message",r),a.debug(" Received groups from content script"),t.data.error?s(new Error(t.data.error)):t.data.groups?(t.data.groups.length,H=0,e(t.data.groups)):s(new Error("Invalid response format")))};window.addEventListener("message",r),t.contentWindow.postMessage({type:"FETCH_USER_GROUPS",requestId:o,tokens:n},"*")})}catch(e){H++;throw new Error(`Group fetching failed (attempt ${H}): ${e.message}. This may be due to Facebook security settings or network issues. Try refreshing the page or logging into Facebook in a new tab.`)}}async function ue(){if(Z)try{const e=await He("lastScanTime");e?(Z.textContent=`Last scan: ${new Date(e).toLocaleString()}`,new Date(e).toLocaleString()):Z.textContent="Last scan: Never"}catch(e){Z.textContent="Last scan: Error loading"}}chrome.runtime.onMessage.addListener((e,t,n)=>{if(e.type,"groupFetchingStarted"===e.type&&(I=!0,Ve(),n({success:!0})),"groupFetchingCompleted"===e.type&&(I=!1,e.error?Ve():Ve(!0),n({success:!0})),"groupsSaved"===e.type&&(a.debug(` ${e.count} groups saved - invalidating cache (UI refresh will happen on groupFetchingCompleted)`),I=!1,q(),n({success:!0})),"scanProgress"===e.type&&(!M&&f&&f.length>0&&function(){if(!F)return void a.debug("User hasn't viewed dashboard yet - keeping all posts as 'new'");a.debug("User has viewed dashboard - marking previous 'new' posts as 'seen' for new scan");const e=f.filter(e=>"new"===e.status);e.length,e.map(e=>e.id).join(", "),a.debug(` Current 'new' posts before marking: ${e.length} posts: ${e.map(e=>e.id).join(", ")}`);const t=JSON.parse(localStorage.getItem("seenPosts")||"[]");let n=0;if(f.forEach(e=>{"new"!==e.status||t.includes(e.id)||(t.push(e.id),e.status="seen",n++)}),n>0){localStorage.setItem("seenPosts",JSON.stringify(t)),a.debug(` Marked ${n} previous 'new' posts as 'seen'`);const e=f.filter(e=>"seen"===e.status&&t.includes(e.id));e.forEach(e=>{chrome.runtime.sendMessage({type:"markPostAsRead",postId:e.id}).catch(e=>{})}),a.debug(` Updated database isRead field for ${e.length} posts`),we()}}(),M?Ye(e.details||"Scanning in progress...",e.progress):Je("Facebook groepen scannen",e.details||"Scanning in progress...",e.progress||0)),"scanCompleted"!==e.type&&"allScansCompleted"!==e.type||(Xe(),ue(),U&&"none"!==U.style.display&&setTimeout(()=>{he()},1e3)),"scanCancelled"===e.type){Xe();const t=document.createElement("div");t.style.cssText='\n      position: fixed;\n      top: 20px;\n      right: 20px;\n      background: #f59e0b;\n      color: white;\n      padding: 12px 16px;\n      border-radius: 8px;\n      display: flex;\n      align-items: center;\n      gap: 8px;\n      z-index: 10000;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;\n      font-size: 14px;\n      max-width: 300px;\n    ',t.innerHTML=`\n      <i class="fas fa-exclamation-triangle"></i>\n      <span>Scan geannuleerd: ${e.reason}</span>\n      <button class="notification-close-btn" style="background: none; border: none; color: white; margin-left: auto; cursor: pointer; font-size: 16px; padding: 0; width: 20px; height: 20px;">âœ•</button>\n    `;const n=t.querySelector(".notification-close-btn");n&&n.addEventListener("click",()=>{t.remove()}),document.body.appendChild(t),setTimeout(()=>{t.parentNode&&t.remove()},6e3)}if("newNotification"===e.type&&(e.notification,it(e.notification)),"groupsUpdated"===e.type&&(q(),Ve()),"keywordsUpdated"===e.type&&Ue(),"GET_USER_PROFILE_VIA_IFRAME"===e.type)return a.debug(" Received iframe user profile request"),mt().then(e=>{a.debug(" User profile fetched via iframe, signed in:",e?.isSignedIn),n({success:!0,profile:e})}).catch(e=>{a.debug(" Iframe profile fetch error:",e.message),n({success:!1,error:e.message})}),!0;if("FETCH_GROUPS_VIA_IFRAME"===e.type)return a.debug(" Received iframe group fetch request"),le().then(e=>{a.debug(" Groups fetched via iframe, count:",e?e.length:0),n({success:!0,groups:e||[]})}).catch(e=>{n({success:!1,error:e.message})}),!0;if("postSavedDuringScanning"===e.type){if(e.post,U&&"none"!==U.style.display&&f){const t=e.post;t&&!f.find(e=>e.id===t.id)&&(t.groupName=(o=t.groupId,A[o]||`Unknown Group (${o})`),t.status="new",t.id,t.isRead,f.unshift(t),we(),"new"===m&&be(),Pe())}n({success:!0})}var o;"scanStatsUpdated"===e.type&&(e.groupId,e.scannedCount,U&&"none"!==U.style.display&&ye(),n({success:!0}))});const ge=document.getElementById("refresh-groups-btn");ge&&ge.addEventListener("click",async()=>{ge.disabled=!0,ge.innerHTML='\n      <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="animate-spin"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>\n      Verversen...\n    ';try{const e=await le();if(!(e&&e.length>0))throw new Error("No groups returned from Facebook");await Ne({type:"saveAllGroups",groups:e}),a.debug(` Successfully refreshed ${e.length} groups`),await Ve(!0);e.length}catch(e){const t=e.message||"";t.includes("login")||t.includes("authentication")||t.includes("sign in")||t.includes("not logged in")||t.includes("fb_dtsg")||t.includes("Missing authentication token")||t.includes("logged into Facebook")||t.includes("GraphQL")?Ke(!1):alert(`Error refreshing groups: ${e.message}\n\nProbeer het opnieuw.`)}finally{setTimeout(()=>{ge.disabled=!1,ge.innerHTML='\n          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 4 23 10 17 10"></polyline><polyline points="1 20 1 14 7 14"></polyline><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"></path></svg>\n          Groepen verversen\n        ',I=!1,setTimeout(()=>{Ve(!0)},1e3)},5e3)}});const me=document.getElementById("add-keyword-btn");me&&W&&(me.addEventListener("click",async()=>{const e=W.value.trim();if(!e)return void W.focus();me.disabled=!0;const t=me.innerHTML;me.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 12l2 2 4-4"></path></svg>';try{await Be(e,!0),W.value="",Ue(),showSuccessNotification("Zoekwoord toegevoegd",`"${e}" is toegevoegd aan positieve zoekwoorden`)}catch(n){n.message.includes("already exists")?(showErrorNotification("Dubbel zoekwoord",n.message),W.focus(),W.select()):n.message.includes("Maximum")?showErrorNotification("Limiet bereikt",n.message):n.message.includes("cannot be empty")||n.message.includes("must be")||n.message.includes("Invalid characters")?(showErrorNotification("Ongeldig zoekwoord",n.message),W.focus()):showErrorNotification("Fout",n.message||"Kan zoekwoord niet opslaan")}finally{me.disabled=!1,me.innerHTML=t}}),W.addEventListener("keypress",e=>{"Enter"===e.key&&me.click()}));const pe=document.getElementById("add-negative-keyword-btn");async function ye(){return d.timeAsync("loadDashboardStats",async()=>{try{["stat-matched-posts","stat-posts-scanned","stat-groups-monitoring","stat-keywords-monitoring"].forEach(e=>{const t=document.getElementById(e);t&&(t.classList.add("loading"),t.textContent="")});const[e,t,n]=await Promise.all([Re(),De(),Ce()]),o=e.length,s=t.filter(e=>!1!==e.enabled).length,a=await ze(),i=n.filter(e=>e.isPositive).length,r=t.reduce((e,t)=>e+(t.scannedPosts||0),0);[{id:"stat-matched-posts",value:o},{id:"stat-posts-scanned",value:r},{id:"stat-groups-monitoring",value:s},{id:"stat-keywords-monitoring",value:i}].forEach(({id:e,value:t},n)=>{setTimeout(()=>{const n=document.getElementById(e);if(n)if(n.classList.remove("loading"),"stat-groups-monitoring"===e&&a.success&&a.monitorLimit){const{maxAllowed:e}=a.monitorLimit;n.innerHTML=`<span style="font-size: inherit;">${t}</span>`}else!function(e,t,n,o){const s=performance.now(),a=t,i=n;function r(t){const n=t-s,c=Math.min(n/o,1),d=1-Math.pow(1-c,3),l=Math.round(a+(i-a)*d);e.textContent=l.toLocaleString(),c<1?requestAnimationFrame(r):e.textContent=i.toLocaleString()}requestAnimationFrame(r)}(n,0,t,1e3)},150*n)})}catch(e){["stat-matched-posts","stat-posts-scanned","stat-groups-monitoring","stat-keywords-monitoring"].forEach(e=>{const t=document.getElementById(e);t&&(t.classList.remove("loading"),t.textContent="-")})}})}async function he(){try{f=await Re();const e=f.reduce((e,t)=>(e[t.isRead?"read":"unread"]++,e),{read:0,unread:0});if(f.length,e.unread,e.read,function(){try{const e=JSON.parse(localStorage.getItem("expandedPosts")||"{}");Object.keys(e).length>0&&(a.debug(` Restoring expanded states for ${Object.keys(e).length} posts`),f.forEach(t=>{!0===e[t.id]?t.isExpanded=!0:!1===e[t.id]&&(t.isExpanded=!1)}))}catch(e){}}(),0===f.length)return void We();a.debug(` Loaded ${f.length} leads from database`);const t=await De(),n={};t.forEach(e=>{n[e.id]=e.name}),f=f.map(e=>({...e,groupName:e.groupName||n[e.groupId]||`Unknown Group (${e.groupId})`,status:fe(e)}));const o=f.reduce((e,t)=>(e[t.status]=(e[t.status]||0)+1,e),{});JSON.stringify(o),f.sort((e,t)=>new Date(t.createdAt)-new Date(e.createdAt)),a.debug(` Processed ${f.length} leads with status classification`),We(),we();const s=f.filter(e=>"new"===e.status).length;if(s>0){a.debug(` ${s} new posts found - auto-selecting "New" tab`);const e=document.querySelectorAll("#dashboard-page .tabs > .tab"),t=document.querySelector('#dashboard-page .tabs > .tab[data-filter="new"]');t&&(e.forEach(e=>e.classList.remove("active")),t.classList.add("active"),m="new",a.debug(' Switched to "New" tab due to new posts'))}else a.debug(' Geen nieuwe posts gevonden - keeping "All" tab active');be(),await Pe()}catch(e){We()}}function fe(e){if(JSON.parse(localStorage.getItem("savedPosts")||"[]").includes(e.id))return"saved";const t=JSON.parse(localStorage.getItem("seenPosts")||"[]").includes(e.id),n=!0===e.isRead;return t||n?(t&&!n?(e.id,a.debug(` Post ${e.id} marked as seen via localStorage (automatic system)`)):n&&!t?(e.id,a.debug(` Post ${e.id} marked as seen via database (manual click)`)):e.id,"seen"):(e.id,e.isRead,"new")}function we(){const e={all:f.length,new:f.filter(e=>"new"===e.status).length,seen:f.filter(e=>"seen"===e.status).length,saved:f.filter(e=>"saved"===e.status).length};Object.keys(e).forEach(t=>{const n=document.getElementById(`${t}-count`);n&&(n.textContent=e[t])}),U&&"none"!==U.style.display&&ye()}function be(){w=function(){let e=[...f];if("all"!==m&&(e=e.filter(e=>e.status===m)),b.length>0&&(e=e.filter(e=>!(!e.keywords||0===e.keywords.length)&&b.some(t=>e.keywords.includes(t)))),v.trim()){const t=v.toLowerCase().trim();e=e.filter(e=>{if(e.content&&"string"==typeof e.content&&e.content.toLowerCase().includes(t))return!0;if(e.author){if("string"==typeof e.author&&e.author.toLowerCase().includes(t))return!0;if("object"==typeof e.author&&e.author.name&&"string"==typeof e.author.name&&e.author.name.toLowerCase().includes(t))return!0}return!1})}return e}(),w.sort((e,t)=>{const n=new Date(e.createdAt),o=new Date(t.createdAt);return"oldest"===p?n-o:o-n}),a.debug(` Sorted ${w.length} leads by ${p}`);const e=U&&"none"!==U.style.display,t="new"===m,n=w.some(e=>"new"===e.status);if(e&&t&&n?(k=!0,E=Date.now(),chrome.storage.sync.set({markNewPostsAsSeenOnNextScan:!0})):(k=!1,E=null,chrome.storage.sync.remove("markNewPostsAsSeenOnNextScan")),K.innerHTML="",0===w.length){let e="Geen posts gevonden";return"new"===m?e="Geen nieuwe posts":"saved"===m&&(e="Geen opgeslagen posts"),K.innerHTML=`\n      <div class="empty-state">\n        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <circle cx="11" cy="11" r="8"></circle>\n          <path d="M21 21l-4.35-4.35"></path>\n        </svg>\n        <h3>${e}</h3>\n        <p>Geen posts komen overeen met je huidige filters. Pas je criteria aan of start een nieuwe scan.</p>\n      </div>\n    `,document.getElementById("scan-from-empty")?.addEventListener("click",()=>{document.getElementById("run-scan-now-btn")?.click()}),void(document.getElementById("pagination-container").style.display="none")}const o=Math.ceil(w.length/h),s=(y-1)*h,i=s+h;w.slice(s,i).forEach(e=>{const t=ve(e);K.appendChild(t)}),function(e){const t=document.getElementById("pagination-container"),n=document.getElementById("pagination-info"),o=document.getElementById("prev-page-btn"),s=document.getElementById("next-page-btn");if(e<=1)return void(t.style.display="none");t.style.display="flex";const a=(y-1)*h+1,i=Math.min(y*h,w.length);n.textContent=`Toont ${a}-${i} van ${w.length} posts`,o.disabled=1===y,s.disabled=y===e,o.onclick=()=>{y>1&&(y--,be())},s.onclick=()=>{y<e&&(y++,be())}}(o)}function ve(e){const t=document.createElement("div");t.className="lead-card",t.setAttribute("data-id",e.id);const n=Se(e.content,e.keywords||[],v),o=e.content.length>400,s=o&&!e.isExpanded?Se(e.content.substring(0,400)+"...",e.keywords||[],v):n,i=Le(new Date(e.createdAt)),r=function(e){if(!e||"Unknown Author"===e)return"?";const t=e.trim().split(/\s+/);if(1===t.length)return t[0].charAt(0).toUpperCase();if(t.length>=2)return(t[0].charAt(0)+t[1].charAt(0)).toUpperCase();return e.charAt(0).toUpperCase()}(e.authorName),c=e.authorProfilePicture?`<img src="${e.authorProfilePicture}" alt="${ke(e.authorName||"Unknown Author")}" style="width: 100%; height: 100%; border-radius: 50%; object-fit: cover;" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">\n     <div style="display: none; width: 100%; height: 100%; border-radius: 50%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; font-weight: 600; font-size: 14px; align-items: center; justify-content: center;">${r}</div>`:r;var d;return t.innerHTML=`\n    <div class="lead-header">\n      <div class="lead-author-section">\n        <div class="lead-avatar" title="${ke(e.authorName||"Unknown Author")}">\n          ${c}\n        </div>\n        <div class="lead-author-info">\n          <div class="lead-author">\n            ${e.authorProfileUrl?`<a href="${ke(e.authorProfileUrl)}" target="_blank" rel="noopener noreferrer" class="author-link" title="View ${ke(e.authorName||"Unknown Author")}'s profile">${Ie(ke(e.authorName||"Unknown Author"),v)}</a>`:Ie(ke(e.authorName||"Unknown Author"),v)}\n          </div>\n          <div class="lead-group">Geplaatst in \n            ${e.groupUrl?`<a href="${ke(e.groupUrl)}" target="_blank" rel="noopener noreferrer" class="group-link" title="Bezoek groep ${ke(e.groupName)}">${ke(e.groupName)}</a>`:ke(e.groupName)} | ${i}\n          </div>\n        </div>\n        </div>\n      <div class="flex items-start gap-2">\n        <span class="status-badge ${e.status}">${ke(({new:"Nieuw",seen:"Gezien",saved:"Opgeslagen"}[e.status]||e.status))}</span>\n      </div>\n    </div>\n    \n    <div class="lead-content ${o&&!e.isExpanded?"collapsed":"expanded"}">\n      ${o&&!e.isExpanded?`${s}... <span class="expand-link" data-action="expand">Toon meer</span>`:s}\n      ${o&&e.isExpanded?' <span class="expand-link" data-action="collapse">Toon minder</span>':""}\n    </div>\n    \n    <div class="lead-footer">\n      <div class="lead-keywords">\n        ${(e.keywords||[]).map(e=>`<span class="keyword-tag">${ke(e)}</span>`).join("")}\n      </div>\n      <div class="lead-actions">\n        <button class="action-btn save ${xe(e.id)?"saved":""}" data-action="toggleSave" title="${xe(e.id)?"Uit opgeslagen verwijderen":"Lead opslaan"}">\n          ${xe(e.id)?"Opgeslagen":"Opslaan"}\n        </button>\n        <button class="action-btn delete" data-action="delete" title="Post verwijderen">\n          Verwijderen\n        </button>\n        <a href="${e.url}" target="_blank" class="action-btn facebook" title="Bekijk op Facebook">\n          Bekijk op Facebook\n        </a>\n      </div>\n      </div>\n    `,function(e,t){const n=e.querySelector('[data-action="expand"], [data-action="collapse"]');n&&n.addEventListener("click",e=>{!function(e,t){const n=e.target.closest("[data-action]").getAttribute("data-action"),o=e.target.closest(".lead-card"),s=o.querySelector(".lead-content");if("expand"===n){t.id,s.classList.add("transitioning"),t.isExpanded=!0;const e=ve(t);o.parentNode.replaceChild(e,o),setTimeout(()=>{const e=document.querySelector(`[data-id="${t.id}"]`),n=e?.querySelector('[data-action="collapse"]');n&&n.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})},100)}else if("collapse"===n){t.id,s.classList.add("transitioning"),t.isExpanded=!1;const e=ve(t);o.parentNode.replaceChild(e,o),setTimeout(()=>{const e=document.querySelector(`[data-id="${t.id}"]`);e&&e.scrollIntoView({behavior:"smooth",block:"nearest",inline:"nearest"})},100)}try{const e=JSON.parse(localStorage.getItem("expandedPosts")||"{}");e[t.id]=t.isExpanded,localStorage.setItem("expandedPosts",JSON.stringify(e))}catch(a){}}(e,t)});const o=e.querySelector('[data-action="toggleSave"]');o&&o.addEventListener("click",()=>{const e=function(e){const t=JSON.parse(localStorage.getItem("savedPosts")||"[]");if(t.includes(e)){const n=t.filter(t=>t!==e);localStorage.setItem("savedPosts",JSON.stringify(n));const o=f.find(t=>t.id===e);return o&&(o.status="seen",we()),!1}{t.push(e),localStorage.setItem("savedPosts",JSON.stringify(t));const n=f.find(t=>t.id===e);return n&&(n.status="saved",we()),chrome.runtime.sendMessage({type:"markPostAsRead",postId:e}).then(()=>{}).catch(e=>{}),!0}}(t.id);e?(t.status="saved",o.classList.add("saved"),o.innerHTML="Opgeslagen",o.title="Uit opgeslagen verwijderen"):(t.status="seen",o.classList.remove("saved"),o.innerHTML="Opslaan",o.title="Lead opslaan"),we()});const s=e.querySelector('[data-action="delete"]');s&&s.addEventListener("click",n=>{n.stopPropagation(),async function(e,t){try{a.debug(` ðŸ—‘ï¸ Delete requested for lead: ${e}`);if(!confirm("Weet je zeker dat je deze post wilt verwijderen? Deze actie kan niet ongedaan worden gemaakt."))return void a.debug(` âŒ Delete cancelled by user for lead: ${e}`);a.debug(` âœ… Delete confirmed for lead: ${e}`),t.style.transition="opacity 0.3s ease, transform 0.3s ease",t.style.opacity="0.5",t.style.transform="scale(0.95)",a.debug(" ðŸ—„ï¸ Deleting from database...");const n=await Ne({type:"deletePost",postId:e});n&&n.success?(a.debug(` âœ… Successfully deleted from database: ${e}`),f=f.filter(t=>t.id!==e),w=w.filter(t=>t.id!==e),setTimeout(()=>{t.style.height=t.offsetHeight+"px",t.style.overflow="hidden",setTimeout(()=>{t.style.transition="height 0.3s ease, margin 0.3s ease, padding 0.3s ease",t.style.height="0",t.style.marginBottom="0",t.style.paddingTop="0",t.style.paddingBottom="0",setTimeout(()=>{t.parentNode&&t.parentNode.removeChild(t),we(),ye();const n=Math.ceil(w.length/h);y>n&&n>0&&(y=n),be(),Pe(),a.debug(` âœ… Lead ${e} successfully removed from UI`)},300)},50)},300)):(t.style.opacity="1",t.style.transform="scale(1)",alert("Kon de post niet verwijderen. Probeer het opnieuw."))}catch(n){t.style.opacity="1",t.style.transform="scale(1)",alert("Er trad een fout op tijdens het verwijderen van de post. Probeer het opnieuw.")}}(t.id,e)})}(t,e),t}function ke(e){const t=document.createElement("div");return t.textContent=e||"",t.innerHTML}function Ee(e){return e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function Le(e){const t=new Date-e,n=Math.floor(t/1e3),o=Math.floor(n/60),s=Math.floor(o/60),a=Math.floor(s/24),i=Math.floor(a/7),r=Math.floor(a/30);return n<30?"Just now":n<60?`${n} seconds ago`:1===o?"1 minute ago":o<60?`${o} minutes ago`:1===s?"1 hour ago":s<24?`${s} hours ago`:1===a?"Yesterday":a<7?`${a} days ago`:1===i?"1 week ago":i<4?`${i} weeks ago`:1===r?"1 month ago":r<12?`${r} months ago`:e.toLocaleDateString()}function Se(e,t,n=null){if(!e)return"";const o=function(e){return e?(e=e.replace(/\[([^\]]+)\]\((https?:\/\/[^)]+)\)/gi,(e,t,n)=>`|||LINK_PLACEHOLDER|||${n}|||TEXT|||${t}|||END|||`)).replace(/(https?:\/\/[^\s\]\)\|]+)/gi,e=>{if(e.includes("|||LINK_PLACEHOLDER|||")||e.includes("|||END|||"))return e;let t=e.replace(/[.,;:!?)\]]+$/,"");const n=e.slice(t.length);try{new URL(t)}catch(s){return e}let o;if(t.includes("facebook.com"))o=t.includes("/groups/")?t.includes("/posts/")||t.includes("/permalink/")?"View Group Post":"View Group":t.includes("/posts/")?"View Post":"Facebook Link";else try{const e=new URL(t);o=e.hostname+("/"!==e.pathname?"...":"")}catch(s){o=t.length>30?t.substring(0,30)+"...":t}return`|||LINK_PLACEHOLDER|||${t}|||TEXT|||${o}|||END|||${n}`}):e}(e);let s=ke(o);if(s=s.replace(/\|\|\|LINK_PLACEHOLDER\|\|\|(.*?)\|\|\|TEXT\|\|\|(.*?)\|\|\|END\|\|\|/g,'<a href="$1" target="_blank" rel="noopener noreferrer" class="post-link">$2</a>'),n&&n.trim()){const e=Ee(n.trim()),t=new RegExp(`(?![^<]*>)(${e})(?![^<]*</)`,"gi");s=s.replace(t,(e,t)=>`<span class="search-highlight">${t}</span>`)}if(t&&t.length>0){[...t].sort((e,t)=>t.length-e.length).forEach(e=>{const t=Ee(e),n=new RegExp(`(?![^<]*>)(?!<span[^>]*>)(${t})(?![^<]*</)(?!</span>)`,"gi");s=s.replace(n,(e,t)=>`<span class="keyword-highlight">${t}</span>`)})}return s}function Ie(e,t){if(!e||!t||!t.trim())return e;const n=Ee(t.trim()),o=new RegExp(`(${n})`,"gi");return e.replace(o,'<span class="search-highlight">$1</span>')}function xe(e){return JSON.parse(localStorage.getItem("savedPosts")||"[]").includes(e)}function Te(e){const t=document.getElementById("subscription-badge"),n=document.getElementById("subscription-icon"),o=document.getElementById("subscription-text");if(!t||!n||!o)return;t.classList.remove("trial","premium","error"),t.classList.add("premium"),t.style.cursor="default",t.onclick=null,n.innerHTML='<path d="M5 16L3 8l5.5 2L12 4l3.5 6L21 8l-2 8H5z"></path><path d="M5 16h14v2H5v-2z"></path><circle cx="12" cy="6" r="2"></circle>',o.textContent="Free Access";}pe&&J&&(pe.addEventListener("click",async()=>{const e=J.value.trim();if(!e)return void J.focus();pe.disabled=!0;const t=pe.innerHTML;pe.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 12l2 2 4-4"></path></svg>';try{await Be(e,!1),J.value="",Ue(),showSuccessNotification("Zoekwoord toegevoegd",`"${e}" is toegevoegd aan negatieve zoekwoorden`)}catch(n){n.message.includes("already exists")?(showErrorNotification("Dubbel zoekwoord",n.message),J.focus(),J.select()):n.message.includes("Maximum")?showErrorNotification("Limiet bereikt",n.message):n.message.includes("cannot be empty")||n.message.includes("must be")||n.message.includes("Invalid characters")?(showErrorNotification("Ongeldig zoekwoord",n.message),J.focus()):showErrorNotification("Fout",n.message||"Kan zoekwoord niet opslaan")}finally{pe.disabled=!1,pe.innerHTML=t}}),J.addEventListener("keypress",e=>{"Enter"===e.key&&pe.click()})),Y&&Y.addEventListener("change",async()=>{const e=parseInt(Y.value);if(isNaN(e)||e<5||e>100)return showErrorNotification("Ongeldige instelling","Posts per scan moeten tussen 5 en 100 liggen"),void(Y.value="18");a.debug(` Posts per scan changed to: ${e}`);try{await Fe("postsPerScan",e),a.debug(` Posts per scan saved: ${e}`),showSuccessNotification("Instellingen bijgewerkt",`Er worden ${e} posts per groep gescand`)}catch(t){showErrorNotification("Fout","Kan instelling niet opslaan")}}),void 0!==Q&&Q&&Q.addEventListener("click",async()=>{Q.disabled=!0;const e=Q.innerHTML;Q.innerHTML='<i class="fas fa-spinner fa-spin"></i> Checking...';try{const n=await Ne({type:"checkScanStatus"},{timeout:5e3});if(n&&n.isRunning){let o="",s=0;if(n.scanStartTime&&(s=Math.floor((Date.now()-n.scanStartTime)/1e3/60),o=` (running for ${s} minutes)`),!(s>10))return Q.innerHTML='<i class="fas fa-exclamation-triangle"></i> Scan Running',setTimeout(()=>{Q.innerHTML=e},3e3),void alert(`Er wordt al ${o} een scan uitgevoerd. Wacht tot deze klaar is voordat je een nieuwe start.`);Q.innerHTML='<i class="fas fa-exclamation-triangle"></i> Reset Stuck Scan';if(!confirm(`Er draait al ${s} minuten een scan en deze lijkt vast te lopen. Wil je de scan resetten en opnieuw starten?`))return void(Q.innerHTML=e);Q.innerHTML='<i class="fas fa-spinner fa-spin"></i> Resetting...';try{const e=await Ne({type:"forceResetScan",reason:"user_manual_reset"},{timeout:5e3});if(!e||!e.success)throw new Error("Failed to reset scan");await new Promise(e=>setTimeout(e,1e3)),Q.innerHTML='<i class="fas fa-spinner fa-spin"></i> Starting...'}catch(t){return Q.innerHTML='<i class="fas fa-exclamation-triangle"></i> Reset Failed',alert("Failed to reset stuck scan. Please try refreshing the page."),void setTimeout(()=>{Q.innerHTML=e},3e3)}}Q.innerHTML='<i class="fas fa-spinner fa-spin"></i> Validating...';const o=await Ce(),s=o&&o.length>0,i=await De(),r=i?i.filter(e=>!1!==e.enabled):[],c=r.length>0;if(!s&&!c)return Q.innerHTML='<i class="fas fa-exclamation-triangle"></i> Setup vereist',setTimeout(()=>{Q.innerHTML=e},3e3),void showWarningNotification("Setup vereist","Voeg minstens Ã©Ã©n zoekwoord toe in Instellingen > Zoekwoorden en schakel minstens Ã©Ã©n groep in via Instellingen > Facebook groepen voordat je een scan start.",8e3);if(!s)return Q.innerHTML='<i class="fas fa-exclamation-triangle"></i> No Keywords',setTimeout(()=>{Q.innerHTML=e},3e3),void showWarningNotification("Geen zoekwoorden gevonden","Voeg minstens Ã©Ã©n zoekwoord toe in Instellingen > Zoekwoorden voordat je een scan start.",6e3);if(!c)return Q.innerHTML='<i class="fas fa-exclamation-triangle"></i> No Groups',setTimeout(()=>{Q.innerHTML=e},3e3),void showWarningNotification("Geen groepen ingeschakeld","Schakel minstens Ã©Ã©n groep in via Instellingen > Facebook groepen voordat je een scan start.",6e3);a.debug(` Validation passed: ${o.length} keywords, ${r.length} enabled groups`),Q.innerHTML='<i class="fas fa-spinner fa-spin"></i> Checking access...';try{const{facebookUserId:t}=await chrome.storage.sync.get("facebookUserId");if(!t)return Q.innerHTML='<i class="fas fa-exclamation-triangle"></i> Niet ingelogd',setTimeout(()=>{Q.innerHTML=e},3e3),void showWarningNotification("Inloggen vereist","Log eerst in op Facebook.",6e3);const n={hasAccess:!0,status:"active"};Te({status:"free"});}catch(t){}const d=await Ne({type:"startBackgroundScan",scanType:"manual"},{timeout:1e4});if(d&&d.success){const n=Date.now();await Fe("lastScanTime",n),Z&&(Z.textContent=`Last scan: ${new Date(n).toLocaleString()}`);try{const e=await Ne({type:"resetNextScanTime"},{timeout:5e3});e&&e.success&&Me()}catch(t){t.message}Je("Handmatige scan gestart","Facebook groepen scannen...",25),Q.innerHTML='<i class="fas fa-check"></i> Scan Started!',setTimeout(()=>{Q.innerHTML=e},2e3)}else{const t=d?.error||"Unknown error",n={scan_already_running:"Er wordt al een scan uitgevoerd. Wacht tot deze klaar is.",TypeError:"Facebook API temporarily unavailable. Please try again in a few minutes.","Failed to fetch":"Network connection issue. Please check your internet connection.","GraphQL request failed":"Facebook API error. Please try again later.",NetworkError:"Network connection issue. Please check your internet connection."},o=Object.keys(n).find(e=>t.includes(e))?n[Object.keys(n).find(e=>t.includes(e))]:`Kan scan niet starten: ${t}`;"scan_already_running"===t?Q.innerHTML='<i class="fas fa-exclamation-triangle"></i> Scan Running':t.includes("TypeError")||t.includes("Failed to fetch")||t.includes("NetworkError")?Q.innerHTML='<i class="fas fa-wifi"></i> Network Issue':Q.innerHTML='<i class="fas fa-exclamation-triangle"></i> Error',alert(o),setTimeout(()=>{Q.innerHTML=e},3e3)}}catch(t){Q.innerHTML='<i class="fas fa-exclamation-triangle"></i> Error',setTimeout(()=>{Q.innerHTML=e},3e3),alert("Error starting scan: "+t.message)}finally{Q.disabled=!1}}),document.addEventListener("DOMContentLoaded",async function(){await D();const e=new URLSearchParams(window.location.search).get("demo");if(null!==e){const t="true"===e;await chrome.storage.sync.set({isDemoMode:t}),window.isDemoMode=t}else{const{isDemoMode:e}=await chrome.storage.sync.get("isDemoMode");window.isDemoMode=e||!1,window.isDemoMode}await async function(){return c.safeAsync(async()=>{r.info("Syncing read status between localStorage and database...");const e=await c.withTimeout(Ne({type:"getPosts"}),15e3,"getPosts sync operation");if(e&&e.success&&e.posts){const t=JSON.parse(localStorage.getItem("seenPosts")||"[]");let n=!1;e.posts.forEach(e=>{!0!==e.isRead||t.includes(e.id)||(t.push(e.id),n=!0)}),n?(localStorage.setItem("seenPosts",JSON.stringify(t)),r.info("Synced read status - updated localStorage")):r.info("Read status already in sync")}else r.warn("No posts to sync or getPosts failed")},null,{operation:"syncReadStatusOnStartup"})}(),async function(){try{const t=await ut();if(t.isLoggedIn){if(Ke(!0),t.userId){await chrome.storage.sync.set({facebookUserId:t.userId});try{const e=await chrome.runtime.sendMessage({type:"checkUserAccess",userId:t.userId});if(e&&!e.hasAccess||"active"!==e.status&&"trial"!==e.status)return e.status,pt(),!1}catch(e){a.warn("Error checking user access:",e)}}}else yt(),ft(1),Ke(!1)}catch(e){e.message,Ke(!1)}}(),he(),Ve(),Ue(),We();const t=document.getElementById("groups-monitoring-card"),n=document.getElementById("keywords-monitoring-card"),o=document.getElementById("matched-posts-card");if(t&&t.addEventListener("click",()=>{const e=document.querySelector('a[href="#settings"]');e&&e.click(),setTimeout(()=>{const e=document.querySelectorAll("#settings-page > .tabs > .tab");e[0]&&e[0].click()},100)}),n&&n.addEventListener("click",()=>{const e=document.querySelector('a[href="#settings"]');e&&e.click(),setTimeout(()=>{const e=document.querySelectorAll("#settings-page > .tabs > .tab");e[1]&&e[1].click()},100)}),o&&o.addEventListener("click",()=>{const e=document.querySelector('a[href="#dashboard"]');e&&e.click(),setTimeout(()=>{const e=document.querySelector('#dashboard-page .tabs > .tab[data-filter="all"]');e&&(a.debug(" Matched posts card clicked - switching to All tab"),e.click())},100)}),Z){const e=await He("lastScanTime");Z.textContent=e?`Last scan: ${new Date(e).toLocaleString()}`:"Last scan: Never"}document.addEventListener("visibilitychange",()=>{document.hidden||ue()});const s=document.getElementById("exact-match-btn"),i=document.getElementById("includes-keyword-btn");s&&s.addEventListener("click",async()=>{a.debug(" Exact match button clicked"),await Fe("keywordMatchType","exact"),s.classList.add("btn-selected"),s.classList.remove("btn-secondary"),i.classList.add("btn-secondary"),i.classList.remove("btn-selected")}),i&&i.addEventListener("click",async()=>{a.debug(" Includes keyword button clicked"),await Fe("keywordMatchType","includes"),i.classList.add("btn-selected"),i.classList.remove("btn-secondary"),s.classList.add("btn-secondary"),s.classList.remove("btn-selected")});const d=await He("postsPerScan");if(a.debug(` Loaded postsPerScan from config: ${d}`),d)Y.value=d,a.debug(` Set postsPerScanSelect.value to: ${d}`);else{a.debug(` No postsPerScan config found, using HTML default: ${Y.value}`);const e=parseInt(Y.value);await Fe("postsPerScan",e),a.debug(` Saved HTML default to database: ${e}`)}"exact"===(await He("keywordMatchType")||"includes")?(document.getElementById("exact-match-btn").classList.add("btn-selected"),document.getElementById("exact-match-btn").classList.remove("btn-secondary"),document.getElementById("includes-keyword-btn").classList.add("btn-secondary"),document.getElementById("includes-keyword-btn").classList.remove("btn-selected")):(document.getElementById("includes-keyword-btn").classList.add("btn-selected"),document.getElementById("includes-keyword-btn").classList.remove("btn-secondary"),document.getElementById("exact-match-btn").classList.add("btn-secondary"),document.getElementById("exact-match-btn").classList.remove("btn-selected"));const l=document.getElementById("scan-interval-select");if(l)try{const e=await new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error("Chrome storage timeout"))},3e3);try{chrome.storage.sync.get(["scanInterval"],o=>{clearTimeout(n),chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):e(o.scanInterval||120)})}catch(o){clearTimeout(n),t(o)}});a.debug(` Loaded scan interval: ${e} minutes`),l.value=e.toString()}catch(g){g.message,l.value="120"}const u=document.getElementById("facebook-login-btn");u&&u.addEventListener("click",()=>{a.debug(" Facebook login button clicked"),chrome.tabs.create({url:"https://www.facebook.com/login"})}),function(){const e=document.querySelector("#groups-table-container");if(!e)return void a.debug(" Groups table container not found for sorting setup");e.addEventListener("click",e=>{const t=e.target.closest("th.sortable");if(!t)return;const n=t.getAttribute("data-sort");if(!n)return;L===n?S="asc"===S?"desc":"asc":(L=n,S="name"===n?"asc":"desc"),a.debug(` Sorting by ${L} (${S})`);const o=Array.from(V.querySelectorAll("tr"));if(o.length>0){const e=o.map(e=>{const t=e.querySelector('input[type="checkbox"]'),n=t?t.getAttribute("data-id"):null;return{row:e,group:P?P.find(e=>e.id===n):null}}).filter(e=>e.group).sort((e,t)=>{let n,o;switch(L){case"name":n=(e.group.name||"").toLowerCase(),o=(t.group.name||"").toLowerCase();break;case"lastVisited":default:n=e.group.lastVisited||0,o=t.group.lastVisited||0;break;case"scannedPosts":n=e.group.scannedPosts||0,o=t.group.scannedPosts||0;break;case"enabled":n=!1!==e.group.enabled?1:0,o=!1!==t.group.enabled?1:0}return"asc"===S?n<o?-1:n>o?1:0:n>o?-1:n<o?1:0});V.innerHTML="",e.forEach(e=>{V.appendChild(e.row)}),_e(L,S)}else Ve(!0)}),a.debug(" Group sorting event listeners set up")}(),Me(),setInterval(Me,6e4),function(){const e=document.getElementById("search-button"),t=document.getElementById("search-dropdown"),n=document.getElementById("search-input"),o=document.getElementById("search-clear");if(!(e&&t&&n&&o))return void a.debug(" Search elements not found");const s=()=>{n.value.trim()?o.style.display="flex":o.style.display="none"},i=()=>{n.value="",v="",be(),s(),n.value.trim()||(t.style.display="none",Qe=!1)};e.addEventListener("click",e=>{e.stopPropagation(),Qe&&!n.value.trim()?(t.style.display="none",Qe=!1):(t.style.display="block",Qe=!0,n.focus())}),n.addEventListener("input",e=>{if(v=e.target.value,v.trim()&&"all"!==m){const e=document.querySelector('#dashboard-page .tabs > .tab[data-filter="all"]');if(e){document.querySelectorAll("#dashboard-page .tabs > .tab").forEach(e=>e.classList.remove("active")),e.classList.add("active"),m="all",y=1,a.debug(' Switched to "All" tab for search')}}be(),s()}),o.addEventListener("click",e=>{e.stopPropagation(),i(),n.focus()}),n.addEventListener("keydown",e=>{"Escape"===e.key&&i()}),document.addEventListener("click",o=>{!Qe||e.contains(o.target)||t.contains(o.target)||n.value.trim()||(t.style.display="none",Qe=!1)}),s(),a.debug(" Search functionality initialized")}(),function(){const e=document.getElementById("notification-bell"),t=document.getElementById("notification-dropdown"),n=document.getElementById("mark-all-read");if(!e||!t)return void a.debug(" Notification bell elements not found");e.addEventListener("click",e=>{e.stopPropagation();const t=document.getElementById("notification-badge");t&&(t.style.display="none",tt=!0),Ze?nt():function(){const e=document.getElementById("notification-dropdown");e&&(e.style.display="block",Ze=!0,ot())}()}),n&&n.addEventListener("click",async()=>{await async function(){try{await Ne({type:"markAllNotificationsAsRead"}),await Ne({type:"markAllPostsAsRead"}),et.forEach(e=>e.read=!0);const e=f.map(e=>e.id),t=JSON.parse(localStorage.getItem("seenPosts")||"[]"),n=[...new Set([...t,...e])];localStorage.setItem("seenPosts",JSON.stringify(n)),f.forEach(e=>{"new"===e.status&&(e.status="seen")}),we(),be()}catch(g){}}(),await ot(),at()});document.addEventListener("click",n=>{Ze&&!t.contains(n.target)&&n.target!==e&&nt()}),ot(),a.debug(" Notification bell initialized")}(),await async function(){try{const e=await chrome.storage.sync.get("accessStatus");e.accessStatus?Te(e.accessStatus):Te({status:"loading"})}catch(g){a.error("Failed to load subscription status:",g),Te({status:"error"})}}(),rt(),await async function(){const e=await async function(){try{const e=await He("setupComplete");return T=!0===e,a.debug(" Setup completion status:",T),T}catch(g){return!1}}();e?a.debug(" Setup complete, skipping modal"):(a.debug(" Setup not complete, showing setup modal"),yt());const t=document.getElementById("setup-step-1-btn");t&&t.addEventListener("click",()=>{e?ht():(a.debug(" Step 1 complete, proceeding to step 2"),ft(2))});const n=document.getElementById("setup-step-2-btn");n&&n.addEventListener("click",()=>{a.debug(" Step 2 complete, proceeding to step 3"),ft(3),initializeStep3()});const o=document.getElementById("setup-step-3-btn");o&&o.addEventListener("click",async()=>{a.debug(" Step 3 complete, proceeding to step 4"),ft(4),initializeStep4()});const s=document.getElementById("setup-step-4-btn");s&&s.addEventListener("click",async()=>{a.debug(" Step 4 complete, starting first scan"),await async function(){try{await Fe("setupComplete",!0),T=!0,a.debug(" Setup marked as complete")}catch(g){}}(),ht(),showSuccessNotification("Setup voltooid","Je eerste scan wordt gestart...");try{const e=await Ne({type:"startBackgroundScan",scanType:"setup"},{timeout:1e4});if(e&&e.success){Je("First Scan Started","Facebook groepen scannen...",25);const e=Date.now();await Fe("lastScanTime",e);const t=document.querySelector('.nav-item[data-page="dashboard"]');t&&t.click()}else showErrorNotification("Scanfout","Eerste scan kon niet worden gestart. Je kunt deze handmatig starten via Instellingen.")}catch(g){showErrorNotification("Scanfout","Eerste scan kon niet worden gestart. Je kunt deze handmatig starten via Instellingen.")}})}(),chrome.runtime.onMessage.addListener((e,t,n)=>{e.type,"batchedNewPosts"!==e.type?"scanProgress"!==e.type?"scanCompleted"!==e.type?"newNotification"!==e.type?"updateDashboard"!==e.type&&("subscriptionStatusUpdated"!==e.type||Te(e.accessStatus)):it(e.notification):Xe():Ye(e.status||"Scanning...",e.progress):e.count}),console.info("%câš ï¸ IMPORTANT: Data Access & Privacy Notice","color: #16a085; font-weight: bold; font-size: 14px; background: #f8f9fa; padding: 8px; border-radius: 4px; display: block; margin: 10px 0;"),console.info("%cThis extension accesses Facebook data to monitor groups and posts for specified keywords. All data processing occurs locally in your browser. We do not store, access, or process any Facebook data on our servers. Any data stored in your browser is temporary and intended only for the extension's functionality. For questions about data handling, contact: info@swapify.com","color: #16a085; font-size: 12px; line-height: 1.5; max-width: 800px; display: block; margin: 5px 0;"),console.info("%cReport any issues at https://swapify.canny.io/","color: #16a085; font-size: 11px; font-style: italic; margin: 5px 0;")}),document.addEventListener("DOMContentLoaded",()=>{const e=document.getElementById("subscribe-btn");e&&e.addEventListener("click",async()=>{try{const{facebookUserId:e}=await chrome.storage.sync.get("facebookUserId");if(e){const t=`https://swapify.com/subscribe/${encodeURIComponent(e)}`;chrome.tabs.create({url:t})}else chrome.tabs.create({url:"https://swapify.com/subscribe/"})}catch(e){chrome.tabs.create({url:"https://swapify.com/subscribe/"})}});const t=document.getElementById("subscribe-modal-close");t&&t.addEventListener("click",()=>{!function(){const e=document.getElementById("subscribe-modal");e&&e.classList.remove("show")}()}),window.addEventListener("blur",()=>{k&&E&&chrome.storage.sync.set({markNewPostsAsSeenOnNextScan:!0})}),document.addEventListener("visibilitychange",()=>{document.hidden&&k&&E&&chrome.storage.sync.set({markNewPostsAsSeenOnNextScan:!0})})});const $e=document.getElementById("scan-interval-select");async function Me(){const e=document.getElementById("next-scan-time");if(e)try{if(!chrome||!chrome.alarms||!chrome.alarms.getAll)return void(e.innerHTML="API unavailable");const t=(await new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error("Chrome alarms timeout"))},3e3);try{chrome.alarms.getAll(o=>{clearTimeout(n),chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):e(o||[])})}catch(o){clearTimeout(n),t(o)}})).find(e=>"fb-group-scan"===e.name);if(t&&t.scheduledTime){const n=new Date(t.scheduledTime),o=new Date,s=n.toLocaleTimeString([],{hour:"2-digit",minute:"2-digit",hour12:!0}),a=n.getTime()-o.getTime(),i=Math.round(a/6e4);if(i>0)if(i<60)e.innerHTML=`${s} (in ${i} minutes)`;else{const t=Math.floor(i/60),n=i%60;e.innerHTML=n>0?`${s} (in ${t}h ${n}m)`:`${s} (in ${t} hours)`}else e.innerHTML=`${s} (due now)`}else e.innerHTML="Not scheduled"}catch(t){t.message,e.innerHTML="Unknown"}}async function Ne(e,t={}){const{timeout:n=5e3,retries:o=0,suppressErrors:s=!1,tabId:a=null}=t;if(!chrome||!chrome.runtime){throw new Error("Chrome runtime not available")}return new Promise((t,o)=>{const i=setTimeout(()=>{const e=new Error("Message timeout");o(e)},n);try{if(a){if(!chrome.tabs||!chrome.tabs.sendMessage){const e=new Error("Chrome tabs API not available");return void o(e)}chrome.tabs.sendMessage(a,e,e=>{if(clearTimeout(i),chrome.runtime.lastError){const e=new Error(chrome.runtime.lastError.message);return s||chrome.runtime.lastError.message.includes("Receiving end does not exist")||chrome.runtime.lastError.message,void o(e)}t(e)})}else{if(!chrome.runtime.sendMessage){const e=new Error("Chrome runtime sendMessage not available");return void o(e)}chrome.runtime.sendMessage(e,e=>{if(clearTimeout(i),chrome.runtime.lastError){const e=new Error(chrome.runtime.lastError.message);return s||chrome.runtime.lastError.message.includes("Receiving end does not exist")||chrome.runtime.lastError.message,void o(e)}t(e)})}}catch(r){clearTimeout(i),s||r.message,o(r)}})}async function Pe(){try{const e=document.getElementById("keyword-filters-container"),t=document.getElementById("keyword-filters-section");if(!e||!t)return;const[n,o]=await Promise.all([Re(),Ce()]),s=(o||[]).filter(e=>!1!==e.isPositive);if(e.innerHTML="",0===s.length)return void(e.innerHTML='\n        <div class="keyword-filters-empty">\n          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>\n          </svg>\n          Voeg eerst positieve zoekwoorden toe via Instellingen > Zoekwoorden.\n        </div>\n      ');const a={};s.forEach(({term:t})=>{t&&(a[t]=0)}),n.forEach(e=>{e.keywords&&Array.isArray(e.keywords)&&e.keywords.forEach(e=>{a.hasOwnProperty(e)||(a[e]=0),a[e]++})});const i=Object.keys(a).sort((e,t)=>{const n=a[t]-a[e];return 0!==n?n:e.localeCompare(t)});0===i.length&&(e.innerHTML='\n        <div class="keyword-filters-empty">\n          <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n            <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"></path>\n          </svg>\n          Geen zoekwoorden om te tonen.\n        </div>\n      '),i.forEach(t=>{const n=a[t],o=b.includes(t),s=document.createElement("div");s.className="keyword-filter-pill"+(o?" selected":""),s.setAttribute("data-keyword",t),s.innerHTML=`\n        <span class=\"keyword-name\">${ke(t)}</span>\n        <span class=\"keyword-count\">${n}</span>\n      `,s.addEventListener("click",()=>{!function(e){const t=b.indexOf(e);t>-1?b.splice(t,1):b.push(e);const n=document.querySelector(`[data-keyword=\"${e}\"]`);n&&n.classList.toggle("selected"),y=1,be()}(t)}),e.appendChild(s)});const r=document.getElementById("clear-keyword-filters");r&&(r.onclick=()=>{!function(){b=[],document.querySelectorAll(".keyword-filter-pill.selected").forEach(e=>e.classList.remove("selected")),be();const e=document.getElementById("clear-keyword-filters");e&&(e.style.display="none")}()})}catch(e){}}async function Be(e,t){g||await D();const n=function(e){const t=e.replace(/<[^>]*>/g,"").trim();if(!t)return{valid:!1,error:"Zoekwoord mag niet leeg zijn"};if(t.length>100)return{valid:!1,error:"Zoekwoord mag maximaal 100 tekens bevatten"};if(t.length<1)return{valid:!1,error:"Zoekwoord mag niet leeg zijn"};const n=[/javascript:/i,/on\w+\s*=/i,/<script/i,/eval\(/i,/expression\(/i];for(const o of n)if(o.test(t))return{valid:!1,error:"Ongeldige tekens in zoekwoord gevonden"};return{valid:!0,sanitized:t}}(e);if(!n.valid)throw new Error(n.error);const o=n.sanitized;if((await Ce()).filter(e=>e.isPositive===t).length>=50){throw new Error(`Maximaal 50 ${t?"positieve":"negatieve"} zoekwoorden toegestaan`)}const s=await async function(e,t){return g||await D(),new Promise((n,o)=>{const s=g.transaction(["keywords"],"readonly").objectStore("keywords").getAll();s.onsuccess=()=>{const o=s.result.some(n=>n.term.toLowerCase()===e.toLowerCase()&&n.isPositive===t);n(o)},s.onerror=e=>{e.target.error,o(e.target.error)}})}(o,t);if(s){throw new Error(`This ${t?"positive":"negative"} keyword already exists`)}return new Promise((e,n)=>{const s=g.transaction(["keywords"],"readwrite").objectStore("keywords"),a={term:o,isPositive:t},i=s.add(a);i.onsuccess=()=>{e()},i.onerror=e=>{e.target.error,n(e.target.error)}})}async function Ae(e){return g||await D(),new Promise((t,n)=>{const o=g.transaction(["keywords"],"readwrite").objectStore("keywords").delete(e);o.onsuccess=()=>{t()},o.onerror=e=>{e.target.error,n(e.target.error)}})}async function Ce(){return g||await D(),new Promise((e,t)=>{const n=g.transaction(["keywords"],"readonly").objectStore("keywords").getAll();n.onsuccess=()=>{e(n.result)},n.onerror=e=>{e.target.error,t(e.target.error)}})}async function Fe(e,t){return g||await D(),new Promise((n,o)=>{const s=g.transaction(["config"],"readwrite").objectStore("config");s.openCursor().onsuccess=a=>{const i=a.target.result;if(i){if(i.value.name===e){const e=i.value;e.value=t;const s=i.update(e);return s.onsuccess=()=>{n()},void(s.onerror=e=>{e.target.error,o(e.target.error)})}i.continue()}else{const a=s.add({name:e,value:t});a.onsuccess=()=>{n()},a.onerror=e=>{e.target.error,o(e.target.error)}}}})}async function He(e){return g||await D(),new Promise((t,n)=>{const o=g.transaction(["config"],"readonly").objectStore("config").openCursor();o.onsuccess=n=>{const o=n.target.result;if(o){if(o.value.name===e)return void t(o.value.value);o.continue()}else t(null)},o.onerror=e=>{e.target.error,n(e.target.error)}})}async function Re(){return g||await D(),new Promise((e,t)=>{const n=g.transaction(["posts"],"readonly").objectStore("posts").getAll();n.onsuccess=()=>{e(n.result)},n.onerror=e=>{e.target.error,t(e.target.error)}})}async function qe(e,t){return g||await D(),new Promise((n,o)=>{const s=g.transaction(["groups"],"readwrite").objectStore("groups"),a=s.get(e);a.onsuccess=a=>{const i=a.target.result;if(i){i.enabled=t;const a=s.put(i);a.onsuccess=async()=>{try{await Ne({type:"updateGroupEnabled",groupId:e,enabled:t},{timeout:1e4,suppressErrors:!0}).catch(e=>{e.message})}catch(o){o.message}n()},a.onerror=e=>{e.target.error,o(e.target.error)}}else o(new Error("Group not found"))},a.onerror=e=>{e.target.error,o(e.target.error)}})}async function De(){return g||await D(),new Promise((e,t)=>{const n=g.transaction(["groups"],"readonly").objectStore("groups").getAll();n.onsuccess=()=>{e(n.result)},n.onerror=e=>{e.target.error,t(e.target.error)}})}async function Ue(){const e=await Ce();j.innerHTML="",z.innerHTML="",e.forEach(e=>{const t=e.isPositive?j:z,n=document.createElement("div");n.className=e.isPositive?"keyword-card keyword-card-positive":"keyword-card keyword-card-negative",n.innerHTML=`\n      <div class="keyword-term">${e.term}</div>\n      <div class="keyword-platforms">\n      \x3c!--\n        <div class="platform-icon active" title="Facebook">\n          <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 2h-3a5 5 0 0 0-5 5v3H7v4h3v8h4v-8h3l1-4h-4V7a1 1 0 0 1 1-1h3z"></path></svg>\n        </div>\n        !--\x3e\n        <div class="platform-icon" title="Verwijderen" data-id="${e.id}">\n          <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>\n        </div>\n      </div>\n    `,t.appendChild(n),n.querySelector('.platform-icon[title="Verwijderen"]').addEventListener("click",async e=>{const t=parseInt(e.currentTarget.getAttribute("data-id"));await Ae(t),Ue()})});try{if(chrome&&chrome.tabs&&chrome.tabs.query){const n=await new Promise((e,t)=>{const n=setTimeout(()=>{t(new Error("Tabs query timeout"))},3e3);try{chrome.tabs.query({url:"https://*.facebook.com/*"},o=>{clearTimeout(n),chrome.runtime.lastError?t(new Error(chrome.runtime.lastError.message)):e(o||[])})}catch(o){clearTimeout(n),t(o)}});for(const o of n)try{await Ne({type:"updateKeywords",keywords:e},{timeout:3e3,suppressErrors:!0,tabId:o.id}).catch(e=>{})}catch(t){}}}catch(t){t.message}U&&"none"!==U.style.display&&ye()}function Oe(e,t,n){return e.sort((e,o)=>{let s,a;switch(t){case"name":s=(e.name||"").toLowerCase(),a=(o.name||"").toLowerCase();break;case"lastVisited":default:s=e.lastVisited||0,a=o.lastVisited||0;break;case"scannedPosts":s=e.scannedPosts||0,a=o.scannedPosts||0;break;case"enabled":s=!1!==e.enabled?1:0,a=!1!==o.enabled?1:0}return"asc"===n?s<a?-1:s>a?1:0:s>a?-1:s<a?1:0})}function _e(e,t){document.querySelectorAll(".table th.sortable").forEach(e=>{e.classList.remove("sort-active","sort-asc","sort-desc")});const n=document.querySelector(`.table th[data-sort="${e}"]`);n&&(n.classList.add("sort-active"),n.classList.add("asc"===t?"sort-asc":"sort-desc"))}function Ge(e,t,n="info"){const o=document.createElement("div");o.className=`notification notification-${n}`,o.style.cssText=`\n    position: fixed;\n    top: 20px;\n    right: 20px;\n    background: ${"error"===n?"#ef4444":"#3b82f6"};\n    color: white;\n    padding: 16px 24px;\n    border-radius: 8px;\n    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);\n    z-index: 10000;\n    max-width: 400px;\n    animation: slideIn 0.3s ease-out;\n  `,o.innerHTML=`\n    <div style="font-weight: 600; margin-bottom: 4px;">${e}</div>\n    <div style="font-size: 14px;">${t}</div>\n  `,document.body.appendChild(o),setTimeout(()=>{o.style.animation="slideOut 0.3s ease-in",setTimeout(()=>o.remove(),300)},5e3)}$e&&$e.addEventListener("change",async()=>{const e=parseInt($e.value);if(isNaN(e)||e<15||e>10080)return showErrorNotification("Ongeldig interval","Scaninterval moet tussen 15 minuten en 1 week liggen"),void($e.value="120");a.debug(` Scan interval changed to: ${e} minutes`);try{const t=await Ne({type:"updateScanInterval",intervalMinutes:e},{timeout:5e3,suppressErrors:!0}).catch(e=>(e.message,{success:!1,error:e.message}));t&&t.success&&(a.debug(" Scan interval updated successfully"),Me())}catch(t){}});const je=document.createElement("style");async function ze(){try{const e=Date.now();if(C.data&&e-C.timestamp<C.ttl)return C.data;const t=await async function(e,t={}){return Ne(e,t)}({type:"getGroupLimits"},{timeout:5e3});if(t&&t.success)return C.data=t,C.timestamp=e,t;return{success:!1,monitorLimit:{maxAllowed:3,currentCount:0,canEnable:!1}}}catch(e){return{success:!1,monitorLimit:{maxAllowed:3,currentCount:0,canEnable:!1}}}}async function Ve(e=!1){!e&&P||a.debug(` loadGroups() called with forceShow: ${e}`);try{const t=await R();if(P&&!e||a.debug(` Retrieved ${t.length} groups (using cache system)`),!V)return;if(V.innerHTML="",X){const e=t.filter(e=>!1!==e.enabled),n=await ze();if(n.success&&n.monitorLimit){const{maxAllowed:o}=n.monitorLimit;X.innerHTML=`Monitoring ${e.length}/${t.length} groups <span style="color: ${e.length>=o?"#ef4444":"#6b7280"};">(Max: ${o})</span>`}else X.textContent=`Monitoring ${e.length}/${t.length} groups`}let n=!1;if(e||(n=await async function(){try{if(I)return!0;const e=Date.now();if(e-x<2e3)return I;x=e;const t=await Ne({type:"getGroupFetchingStatus"},{timeout:2e3,suppressErrors:!0}).catch(()=>({isFetching:!1})),n=t&&!0===t.isFetching;return a.debug(` Background script fetching status: ${n}`),n||(I=!1),n}catch(e){return e.message,I=!1,!1}}()),n&&!e){const e=document.createElement("tr");return e.innerHTML='\n        <td colspan="5" style="text-align: center; padding: 40px;">\n          <div class="loading-container">\n            <div class="loading-spinner"></div>\n            <div style="margin-top: 16px; color: #666;">\n              <strong>Je Facebook groepen ophalen...</strong>\n            </div>\n            <div style="margin-top: 8px; color: #888; font-size: 14px;">\n              Dit kan even duren\n            </div>\n          </div>\n        </td>\n      ',V.appendChild(e),void setTimeout(()=>{I=!1,Ve(!0)},3e4)}if(0===t.length){const e=document.createElement("tr");return e.innerHTML='\n        <td colspan="5" style="text-align: center; padding: 40px;">\n          <div style="color: #666;">\n            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 16px; opacity: 0.5;">\n              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>\n              <circle cx="9" cy="7" r="4"></circle>\n              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>\n              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>\n            </svg>\n            <div><strong>Geen groepen gevonden</strong></div>\n            <div style="margin-top: 8px; font-size: 14px;">\n              Visit Facebook groups while the extension is active, or click "Groepen verversen" to fetch them automatically.\n            </div>\n          </div>\n        </td>\n      ',void V.appendChild(e)}const o=Oe(t,L,S);a.debug(` Sorted groups by ${L} (${S})`),_e(L,S);const s=await ze(),i=!s.success||s.monitorLimit.canEnable;o.forEach((e,t)=>{const n=document.createElement("tr"),o=e.lastVisited?Le(new Date(e.lastVisited)):"Never",a=!i&&!1===e.enabled,r=a?"disabled":"",c=a?`title="You've reached your limit of ${s.monitorLimit.maxAllowed} monitored groups"`:"";n.innerHTML=`\n        <td class="checkbox-cell">\n          <input type="checkbox" ${!1!==e.enabled?"checked":""} data-id="${e.id}" id="checkbox-${e.id}" ${r} ${c}>\n        </td>\n        <td>\n          <span class="group-name-clickable" data-checkbox-id="checkbox-${e.id}" style="${a?"color: #9ca3af; cursor: not-allowed;":""}">\n            ${e.name||"Unknown Group"}\n          </span>\n        </td>\n        <td>${o}</td>\n        <td>${e.scannedPosts||0}</td>\n        <td>\n          <button class="btn btn-secondary visit-btn" data-url="${e.url}">Bezoeken</button>\n        </td>\n      `,V.appendChild(n);const d=n.querySelector('input[type="checkbox"]'),l=n.querySelector(".group-name-clickable");d.addEventListener("change",async e=>{const t=e.currentTarget.getAttribute("data-id"),n=e.currentTarget.checked;try{await qe(t,n),C.data=null;const e=await ze();if(X&&P){const o=P.find(e=>e.id===t);o&&(o.enabled=n);const s=P.filter(e=>!1!==e.enabled);if(e.success&&e.monitorLimit){const{maxAllowed:t}=e.monitorLimit;X.innerHTML=`Monitoring ${s.length}/${P.length} groups <span style="color: ${s.length>=t?"#ef4444":"#6b7280"};">(Max: ${t})</span>`}else X.textContent=`Monitoring ${s.length}/${P.length} groups`}await async function(e=null){e||(e=await ze());const t=!!e.success&&e.monitorLimit.canEnable;document.querySelectorAll('#groups-table-body input[type="checkbox"]').forEach(n=>{const o=n.checked,s=!t&&!o;n.disabled=s;const a=n.closest("tr");if(a){const t=a.querySelector(".group-name-clickable");t&&(s?(t.style.color="#9ca3af",t.style.cursor="not-allowed",n.title=`You've reached your limit of ${e.monitorLimit.maxAllowed} monitored groups`):(t.style.color="",t.style.cursor="",n.title=""))}})}(e)}catch(o){e.currentTarget.checked=!n,"GROUP_LIMIT_EXCEEDED"===o.code&&o.details?Ge("Group Limiet bereikt",`You can monitor up to ${o.details.maxAllowed} groups with your current subscription. Please upgrade to monitor more groups.`,"error"):Ge("Error",o.message||"Failed to update group","error")}}),l.addEventListener("click",()=>{d.disabled||(d.checked=!d.checked,d.dispatchEvent(new Event("change")))}),n.querySelector(".visit-btn").addEventListener("click",async e=>{const t=e.currentTarget.getAttribute("data-url");try{if(!chrome||!chrome.tabs||!chrome.tabs.create)return void window.open(t,"_blank");await new Promise((e,n)=>{const o=setTimeout(()=>{n(new Error("Tab creation timeout"))},5e3);try{chrome.tabs.create({url:t},t=>{clearTimeout(o),chrome.runtime.lastError?n(new Error(chrome.runtime.lastError.message)):e(t)})}catch(s){clearTimeout(o),n(s)}})}catch(n){n.message,window.open(t,"_blank")}})}),a.debug(` Successfully loaded ${o.length} groups into UI (performance optimized)`),U&&"none"!==U.style.display&&ye()}catch(t){}}function Ke(e){a.debug(` Updating Facebook login status: ${e}`),We()}function We(){const e=document.getElementById("no-leads-message"),t=document.getElementById("main-content");e&&t&&(f&&f.length>0?(e.style.display="none",t.style.display="block"):(e.style.display="block",t.style.display="none"))}function Je(e="Facebook groepen scannen",t="Zoeken naar nieuwe posts...",n=0){const o=document.getElementById("scan-indicator"),s=document.querySelector(".scan-indicator-title"),a=document.getElementById("scan-details"),i=document.getElementById("scan-progress"),r=document.querySelector(".main-content");o&&(N&&clearTimeout(N),s&&(s.textContent=e),a&&(a.textContent=t),i&&(i.style.width=`${Math.min(100,Math.max(0,n))}%`),M||(o.style.display="block",M=!0,r&&r.classList.add("scan-active")),N=setTimeout(()=>{Xe()},3e5))}function Ye(e,t=null){const n=document.getElementById("scan-details"),o=document.getElementById("scan-progress");n&&(n.textContent=e),o&&null!==t&&(o.style.width=`${Math.min(100,Math.max(0,t))}%`)}function Xe(){const e=document.getElementById("scan-indicator"),t=document.querySelector(".main-content");e&&M&&(N&&(clearTimeout(N),N=null),e.style.display="none",M=!1,t&&t.classList.remove("scan-active"))}je.textContent="\n  @keyframes slideIn {\n    from { transform: translateX(100%); opacity: 0; }\n    to { transform: translateX(0); opacity: 1; }\n  }\n  @keyframes slideOut {\n    from { transform: translateX(0); opacity: 1; }\n    to { transform: translateX(100%); opacity: 0; }\n  }\n",document.head.appendChild(je);let Qe=!1;let Ze=!1,et=[],tt=!1;function nt(){const e=document.getElementById("notification-dropdown");e&&(e.style.display="none",Ze=!1)}async function ot(){a.debug(" loadNotifications called");try{const e=await Ne({type:"getRecentNotifications",limit:10});a.debug(" Notifications response:",e),e&&e.success?(et=e.notifications||[],a.debug(" Loaded notifications:",et.length),a.debug(" Notifications detail:",et.map(e=>({id:e.id,type:e.type,read:e.read,message:e.message?.substring(0,50)+"..."}))),st(et),at()):(st([]),et=[],at())}catch(e){st([]),et=[],at()}}function st(e){const t=document.getElementById("notification-list");if(!t)return;if(0===e.length)return void(t.innerHTML='\n      <div class="notification-empty">\n        <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n          <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>\n          <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>\n        </svg>\n        <p>Nog geen meldingen</p>\n        \n      </div>\n    ');t.innerHTML=e.map(e=>{const t=Le(new Date(e.timestamp));return`\n      <div class="notification-item ${e.read?"":"unread"}" data-notification-id="${e.id}">\n        <div class="notification-title">${e.title}</div>\n        <div class="notification-message">${e.message}</div>\n        <div class="notification-time">${t}</div>\n      </div>\n    `}).join("");t.querySelectorAll(".notification-item").forEach(t=>{t.addEventListener("click",async()=>{const n=t.dataset.notificationId;a.debug(" Notification clicked:",n);const o=e.find(e=>e.id===n);if(a.debug(" Notification data:",o),a.debug(" Is unread?",o&&!o.read),o&&!o.read&&(a.debug(" Marking notification as read..."),await async function(e){a.debug(" markNotificationAsRead called for:",e);try{await Ne({type:"markNotificationAsRead",notificationId:e});const t=et.find(t=>t.id===e);a.debug(" Found notification:",t),t?(a.debug(" Notification read status before:",t.read),t.read=!0,a.debug(" Notification read status after:",t.read)):a.debug(" Warning: Notification not found in recentNotifications array")}catch(t){}}(n),t.classList.remove("unread"),a.debug(" Updating badge after marking as read..."),at()),o&&"scan_summary"===o.type){nt();const e=document.querySelector('[href="#dashboard"]');e&&e.click()}})})}function at(){const e=document.getElementById("notification-badge"),t=document.getElementById("notification-bell");if(!e||!t)return;a.debug(" updateNotificationBadge called"),a.debug(" Badge cleared state:",tt),a.debug(" Total notifications:",et.length),a.debug(" Notifications state:",et.map(e=>({id:e.id,type:e.type,read:e.read,message:e.message?.substring(0,50)+"..."})));const n=et.filter(e=>!e.read).length;if(a.debug(" Unread count:",n),tt)return e.style.display="none",void t.classList.remove("has-notifications");n>0?(e.textContent=n>99?"99+":n.toString(),e.style.display="flex",t.classList.add("has-notifications")):(e.style.display="none",t.classList.remove("has-notifications"))}function it(e){a.debug(" New notification received:",e);-1===et.findIndex(t=>t.id===e.id)?(et.unshift(e),et.length>10&&(et=et.slice(0,10)),tt=!1,Ze&&st(et),at()):a.debug(" Notification already exists, skipping duplicate:",e.id)}async function rt(){a.debug(" Initializing alert settings...");try{const e=await Ne({type:"getAlertSettings"});if(e&&e.success){const t=e.settings,n=document.getElementById("notifications-enabled"),o=document.getElementById("badge-enabled");n&&(n.checked=t.notifications),o&&(o.checked=t.badge),a.debug(" Alert settings loaded:",t)}}catch(e){}!function(){const t=document.getElementById("notifications-enabled"),n=document.getElementById("badge-enabled");t&&t.addEventListener("change",async t=>{const n=t.target.checked;a.debug(" Browser notifications "+(n?"enabled":"disabled"));try{await Ne({type:"updateAlertSettings",settings:{notifications:n}}),a.debug(" Notification setting updated successfully")}catch(e){t.target.checked=!n}});n&&n.addEventListener("change",async t=>{const n=t.target.checked;a.debug(" Extension badge "+(n?"enabled":"disabled"));try{await Ne({type:"updateAlertSettings",settings:{badge:n}}),a.debug(" Badge setting updated successfully"),n||await Ne({type:"updateBadgeCount"})}catch(e){t.target.checked=!n}});a.debug(" Alert settings event listeners setup complete")}()}let ct=0;function dt(e,t,n,o=5e3){const s=document.getElementById("notification-container");if(!s)return null;const a=document.createElement("div");a.className=`notification ${e}`,a.setAttribute("data-id",++ct);let i="";switch(e){case"success":i='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="20,6 9,17 4,12"></polyline></svg>';break;case"error":i='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="15" y1="9" x2="9" y2="15"></line><line x1="9" y1="9" x2="15" y2="15"></line></svg>';break;case"warning":i='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 9v2"></path><path d="M12 17h.01"></path><path d="M3 3h18l-9 15z"></path></svg>';break;default:i='<svg xmlns="http://www.w3.org/2000/svg" width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M12 16v-4"></path><path d="M12 8h.01"></path></svg>'}a.innerHTML=`\n    <div class="notification-icon">\n      ${i}\n    </div>\n    <div class="notification-content">\n      <div class="notification-title">${ke(t)}</div>\n      ${n?`<div class="notification-message">${ke(n)}</div>`:""}\n    </div>\n    <button class="notification-close" type="button">\n      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n        <line x1="18" y1="6" x2="6" y2="18"></line>\n        <line x1="6" y1="6" x2="18" y2="18"></line>\n      </svg>\n    </button>\n  `;return a.querySelector(".notification-close").addEventListener("click",()=>{lt(a)}),s.appendChild(a),requestAnimationFrame(()=>{a.classList.add("show")}),o>0&&setTimeout(()=>{lt(a)},o),a}function lt(e){e&&e.parentNode&&(e.classList.remove("show"),setTimeout(()=>{e.parentNode&&e.parentNode.removeChild(e)},300))}async function ut(){try{a.debug(" Checking Facebook login via cookie...");const e=await chrome.runtime.sendMessage({type:"checkFacebookLoginViaCookie"});return e&&e.success?(a.debug(" Facebook login check result:",{isLoggedIn:e.isLoggedIn,userId:e.userId?"Found":"Missing"}),{isLoggedIn:e.isLoggedIn,userId:e.userId,method:"cookie"}):(a.warn(" Failed to check Facebook login via cookie:",e?.error),{isLoggedIn:!1,userId:null,method:"cookie",error:e?.error})}catch(e){return a.error(" Error checking Facebook login status:",e),{isLoggedIn:!1,userId:null,method:"cookie",error:e.message}}}window.showSuccessNotification=(e,t,n)=>dt("success",e,t,n),window.showErrorNotification=(e,t,n)=>dt("error",e,t,n),window.showWarningNotification=(e,t,n)=>dt("warning",e,t,n),window.showInfoNotification=(e,t,n)=>dt("info",e,t,n);const gt=4;async function mt(){try{a.debug(" Getting user profile using iframe approach...");let t=document.querySelector("#FB_GROUP_FETCH_IFRAME");t||(a.debug(" Creating Facebook iframe for user profile..."),t=document.createElement("iframe"),t.id="FB_GROUP_FETCH_IFRAME",t.src="https://www.facebook.com/",t.style.height="100vh",t.style.width="100vw",t.style.position="absolute",t.style.top="0",t.style.left="0",t.style.zIndex="-1",t.style.opacity="0",t.style.pointerEvents="none",document.body.appendChild(t),await new Promise(e=>setTimeout(e,8e3)),a.debug(" Facebook iframe created for user profile")),await new Promise(e=>setTimeout(e,3e3)),a.debug(" Testing iframe communication for user profile...");const n=Date.now().toString();try{await new Promise((e,o)=>{const s=setTimeout(()=>{o(new Error("PING timeout - iframe communication not working"))},5e3),i=t=>{"PONG"===t.data.type&&t.data.requestId===n&&(clearTimeout(s),window.removeEventListener("message",i),a.debug(" PING successful for user profile - iframe communication working"),e())};window.addEventListener("message",i),t.contentWindow.postMessage({type:"PING",requestId:n},"*")})}catch(e){throw e.message,e}a.debug(" Requesting user profile from content script...");const o=Date.now().toString();return new Promise((e,n)=>{const s=setTimeout(()=>{n(new Error("Timeout waiting for user profile (15s)"))},15e3),i=t=>{if("USER_PROFILE_RESPONSE"===t.data.type&&t.data.requestId===o){clearTimeout(s),window.removeEventListener("message",i),a.debug(" Received user profile from content script");const o=t.data.profile;o.error?n(new Error(`Content script error: ${o.error}`)):(a.debug(" Successfully got user profile:",{isSignedIn:o.isSignedIn,firstName:o.firstName?"Found":"Missing",fullName:o.fullName?"Found":"Missing",profilePicture:o.profilePicture?"Found":"Missing",userId:o.userId?"Found":"Missing",method:o.method||"unknown"}),e(o))}};window.addEventListener("message",i),t.contentWindow.postMessage({type:"GET_USER_PROFILE",requestId:o},"*")})}catch(e){throw new Error(`User profile extraction failed: ${e.message}`)}}function pt(){}function yt(){const e=document.getElementById("setup-modal");e&&(e.classList.add("show"),ft(1))}function ht(){const e=document.getElementById("setup-modal");e&&e.classList.remove("show")}function ft(e){const t=document.getElementById("setup-progress-fill"),n=document.getElementById("setup-progress-current"),o=document.querySelector(".onboarding-container"),s=document.querySelector(".onboarding-progress-bar");if(o){4===e?o.classList.add("thankyou-active"):o.classList.remove("thankyou-active")}s&&(s.style.display=4===e?"none":"block");if(t){const n=e/gt*100;t.style.width=`${n}%`}n&&(n.textContent=e);document.querySelectorAll(".setup-step").forEach(e=>{e.classList.remove("active")});const a=document.getElementById(`setup-step-${e}`);a&&a.classList.add("active"),1===e?initializeStep1():2===e&&initializeStep2()}async function wt(){try{const e=await Ce();!function(e){const t=document.getElementById("setup-keywords-container"),n=document.getElementById("setup-keywords-empty");if(!t||!n)return;t.innerHTML="",0===e.length?(n.style.display="block",t.style.display="none"):(n.style.display="none",t.style.display="grid",e.forEach(e=>{const n=document.createElement("div");n.className="keyword-card keyword-card-positive",n.innerHTML=`\n        <div class="keyword-term">${ke(e.term)}</div>\n        <div class="keyword-platforms">\n          <div class="platform-icon" title="Verwijderen" data-id="${e.id}">\n            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M3 6h18"></path><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>\n          </div>\n        </div>\n      `,t.appendChild(n),n.querySelector('.platform-icon[title="Verwijderen"]').addEventListener("click",async e=>{const t=parseInt(e.currentTarget.getAttribute("data-id"));await Ae(t),await wt()})}))}(e.filter(e=>e.isPositive)),vt()}catch(e){}}async function bt(){const e=document.getElementById("setup-keyword-input"),t=document.getElementById("setup-add-keyword-btn");if(!e||!t)return;const n=e.value.trim();if(!n)return void e.focus();t.disabled=!0;const o=t.innerHTML;t.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><path d="M8 12l2 2 4-4"></path></svg>';try{await Be(n,!0),e.value="",await wt(),showSuccessNotification("Zoekwoord toegevoegd",`"${n}" added to positive keywords`)}catch(s){s.message.includes("already exists")?(showErrorNotification("Dubbel zoekwoord","Dit positieve zoekwoord bestaat al"),e.focus(),e.select()):showErrorNotification("Fout","Kan zoekwoord niet opslaan: "+s.message)}finally{t.disabled=!1,t.innerHTML=o}}function vt(){const e=document.getElementById("setup-step-3-btn"),t=document.getElementById("setup-keywords-container");if(!e)return;const n=t&&t.children.length>0&&"none"!==t.style.display;e.disabled=!n}async function kt(e){const t=document.getElementById("setup-groups-status"),n=document.getElementById("setup-groups-table-container"),o=document.getElementById("setup-groups-table-body"),s=document.getElementById("setup-groups-count"),a=document.getElementById("setup-step-2-btn");if(e.length,t&&(t.style.display="none"),n&&(n.style.display="block"),s){const t=e.filter(e=>!1!==e.enabled).length;s.textContent=`Found ${e.length} groups (${t} selected)`}if(o&&(o.innerHTML=""),0===e.length){if(o){const e=document.createElement("tr");e.innerHTML='\n        <td colspan="3" style="text-align: center; padding: 40px;">\n          <div style="color: #666;">\n            <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" style="margin-bottom: 16px; opacity: 0.5;">\n              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>\n              <circle cx="9" cy="7" r="4"></circle>\n              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>\n              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>\n            </svg>\n            <div><strong>Geen groepen gevonden</strong></div>\n            <div style="margin-top: 8px; font-size: 14px;">\n              We konden geen Facebook groepen vinden die aan je account gekoppeld zijn.\n            </div>\n          </div>\n        </td>\n      ',o.appendChild(e)}return void(a&&(a.disabled=!1))}const i=Oe(e,"lastVisited","desc"),r=await ze(),c=!r.success||r.monitorLimit.canEnable;i.forEach((e,t)=>{const n=document.createElement("tr"),s=e.lastVisited?Le(new Date(e.lastVisited)):"Never",a=!c&&!0!==e.enabled,i=a?"disabled":"",d=a?`title="You've reached your limit of ${r.monitorLimit.maxAllowed} monitored groups"`:"";n.innerHTML=`\n      <td class="checkbox-cell">\n        <input type="checkbox" ${!0===e.enabled?"checked":""} data-id="${e.id}" id="setup-checkbox-${e.id}" ${i} ${d}>\n      </td>\n      <td>\n        <span class="group-name-clickable" data-checkbox-id="setup-checkbox-${e.id}" style="${a?"color: #9ca3af; cursor: not-allowed;":""}">\n          ${ke(e.name||"Unknown Group")}\n        </span>\n      </td>\n      <td>${s}</td>\n    `,o.appendChild(n);const l=n.querySelector('input[type="checkbox"]'),u=n.querySelector(".group-name-clickable");l.addEventListener("change",async e=>{const t=e.currentTarget.getAttribute("data-id"),n=e.currentTarget.checked;try{await qe(t,n),function(){const e=document.getElementById("setup-groups-count"),t=document.querySelectorAll('#setup-groups-table-body input[type="checkbox"]');if(e&&t.length>0){const n=Array.from(t).filter(e=>e.checked).length,o=t.length;e.textContent=`Found ${o} groups (${n} selected)`}Et()}(),C.data=null,await async function(){const e=await ze(),t=!!e.success&&e.monitorLimit.canEnable;document.querySelectorAll('#setup-groups-table-body input[type="checkbox"]').forEach(n=>{const o=n.checked,s=!t&&!o;n.disabled=s;const a=n.closest("tr");if(a){const t=a.querySelector(".group-name-clickable");t&&(s?(t.style.color="#9ca3af",t.style.cursor="not-allowed",n.title=`You've reached your limit of ${e.monitorLimit.maxAllowed} monitored groups`):(t.style.color="",t.style.cursor="",n.title=""))}})}()}catch(o){e.currentTarget.checked=!n,"GROUP_LIMIT_EXCEEDED"===o.code&&o.details?Ge("Group Limiet bereikt",`You can monitor up to ${o.details.maxAllowed} groups with your current subscription. Please upgrade to monitor more groups.`,"error"):Ge("Error",o.message||"Failed to update group","error")}}),u.addEventListener("click",()=>{l.disabled||(l.checked=!l.checked,l.dispatchEvent(new Event("change")))})}),Et(),function(){const e=document.getElementById("setup-groups-table-container");if(!e)return;if(e.getAttribute("data-sort-handler"))return;e.setAttribute("data-sort-handler","true"),e.addEventListener("click",e=>{const t=e.target.closest(".sortable");if(!t)return;const n=t.getAttribute("data-sort"),o="asc"===(t.getAttribute("data-direction")||"asc")?"desc":"asc";document.querySelectorAll("#setup-groups-table-container .sortable").forEach(e=>{e.removeAttribute("data-direction"),e.classList.remove("sort-asc","sort-desc")}),t.setAttribute("data-direction",o),t.classList.add(`sort-${o}`),async function(e,t){try{const n=await R();kt(Oe(n,e,t))}catch(n){}}(n,o)})}();const d=document.querySelector('#setup-groups-table-container .sortable[data-sort="lastVisited"]');d&&(d.setAttribute("data-direction","desc"),d.classList.add("sort-desc")),i.length}function Et(){const e=document.getElementById("setup-step-2-btn"),t=document.querySelectorAll('#setup-groups-table-body input[type="checkbox"]');if(e&&t.length>0){const n=Array.from(t).filter(e=>e.checked).length;e.disabled=0===n}}window.initializeStep1=async function e(){a.debug(" Initializing setup step 1: Facebook login check");const t=document.getElementById("setup-welcome-title"),n=document.getElementById("setup-subtitle"),o=document.getElementById("setup-facebook-status"),s=document.getElementById("setup-connect-facebook"),i=document.getElementById("setup-step-1-btn");o&&(o.innerHTML='\n      <div class="setup-loading">\n        <div class="loading-spinner"></div>\n        <p>Facebook login status controleren...</p>\n      </div>\n    '),i&&(i.disabled=!0);try{const c=await ut(),{isDemoMode:d}=await chrome.storage.sync.get("isDemoMode");let l;if(d)l={isSignedIn:!0,userId:"12345",firstName:"Demo",fullName:"Demo User",profilePicture:"",method:"demo"},a.debug(" Demo mode active - using demo profile");else if(c.isLoggedIn&&c.userId){l={isSignedIn:!0,userId:c.userId,firstName:"",fullName:"",profilePicture:"",method:"cookie"};try{const e=await mt();e.isSignedIn&&(l.firstName=e.firstName,l.fullName=e.fullName,l.profilePicture=e.profilePicture,l.method="cookie+iframe")}catch(r){}}else l={isSignedIn:!1,userId:null,firstName:"",fullName:"",profilePicture:"",method:"cookie",error:"Not logged in"};if($=l,l.isSignedIn&&l.firstName){if(t&&(t.textContent=`Welkom, ${l.firstName}!`),n&&(n.style.display="block"),o){const e=l.firstName.charAt(0)+(l.fullName.split(" ")[1]?.charAt(0)||"");o.innerHTML=`\n          <div class="setup-user-profile">\n            <div class="setup-user-avatar">\n              ${l.profilePicture?`<img src="${l.profilePicture}" alt="${l.fullName}" onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';">\n                <div class="initials" style="display: none;">${e}</div>`:`<div class="initials">${e}</div>`}\n            </div>\n            <div class="setup-user-info">\n              <h3>${l.fullName}</h3>\n              <p>Verbonden met Facebook</p>\n            </div>\n          </div>\n        `}s&&(s.style.display="block"),i&&(i.disabled=!1)}else{if(t&&(t.textContent="Log in op Facebook"),n&&(n.style.display="none"),o){o.innerHTML='\n            <div style="text-align: center;">\n              <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">\n                <h3 style="color: #7f1d1d; margin: 0 0 0.5rem 0; font-size: 1.125rem;">Niet ingelogd</h3>\n                <p style="color: #7f1d1d; margin: 0;">Log in op Facebook in een ander tabblad en keer hier terug om verder te gaan.</p>\n              </div>\n              <button class="btn btn-primary" id="open-facebook-login-btn">\n                Open Facebook-login\n              </button>\n              <br><br>\n              <button class="btn btn-link" id="check-again-btn">\n                Ik ben ingelogd, controleer opnieuw\n              </button>\n            </div>\n          ';const t=o.querySelector("#open-facebook-login-btn"),n=o.querySelector("#check-again-btn");t&&t.addEventListener("click",()=>{chrome.tabs.create({url:"https://www.facebook.com/login"})}),n&&n.addEventListener("click",async()=>{e()})}s&&(s.style.display="none"),i&&(i.disabled=!0)}}catch(c){if(n&&(n.style.display="none"),o){o.innerHTML=`\n        <div style="text-align: center; padding: 2rem;">\n          <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">\n            <h3 style="color: #dc2626; margin: 0 0 0.5rem 0; font-size: 1.125rem;">Verbindingsfout</h3>\n            <p style="color: #7f1d1d; margin: 0; font-size: 0.875rem;">${c.message}</p>\n          </div>\n          <button class="btn btn-primary" id="try-again-btn">\n            Probeer opnieuw\n          </button>\n        </div>\n      `;const t=o.querySelector("#try-again-btn");t&&t.addEventListener("click",()=>{e()})}}},window.initializeStep2=async function e(){a.debug(" Initializing setup step 2: Select Facebook groups");const t=document.getElementById("setup-groups-status"),n=document.getElementById("setup-groups-table-container"),o=document.getElementById("setup-step-2-btn");t&&(t.innerHTML='\n      <div class="setup-loading">\n        <div class="loading-spinner"></div>\n        <p>Je Facebook groepen laden...</p>\n      </div>\n    ',t.style.display="block"),n&&(n.style.display="none"),o&&(o.disabled=!0);try{await async function(){try{a.debug(" Loading groups for setup using existing system...");const{isDemoMode:e}=await chrome.storage.sync.get("isDemoMode");if(e){a.debug(" Demo mode active - loading demo groups after delay..."),await new Promise(e=>setTimeout(e,5e3));const e=await fetch(chrome.runtime.getURL("demo-data.json")),t=await e.json(),n=await D(),o=n.transaction(["groups"],"readwrite").objectStore("groups");await new Promise((e,t)=>{const n=o.clear();n.onsuccess=()=>e(),n.onerror=()=>t(n.error)});for(const a of t.groups)await new Promise((e,t)=>{const n=o.add({id:a.id,name:a.name,url:a.url,lastVisited:a.lastVisited||null,enabled:void 0!==a.enabled&&a.enabled,scannedPosts:a.scannedPosts||0});n.onsuccess=()=>e(),n.onerror=()=>t(n.error)});q();const s=t.groups;return s.length,void kt(s)}let t=await R();if(0===t.length){a.debug(" No cached groups found, triggering fresh fetch...");const e=await le();if(e&&e.length>0){const n=await D(),o=n.transaction(["groups"],"readwrite").objectStore("groups");await new Promise((e,t)=>{const n=o.clear();n.onsuccess=()=>e(),n.onerror=()=>t(n.error)});for(const t of e)await new Promise((e,n)=>{const s=o.add({id:t.id,name:t.name,url:t.url,lastVisited:t.lastVisited||null,enabled:void 0!==t.enabled&&t.enabled,scannedPosts:t.scannedPosts||0});s.onsuccess=()=>e(),s.onerror=()=>n(s.error)});q(),t=e,t.length}}kt(t)}catch(e){throw new Error(`Failed to load Facebook groups: ${e.message}`)}}()}catch(s){if(t){t.innerHTML=`\n        <div style="text-align: center; padding: 2rem;">\n          <div style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem;">\n            <h3 style="color: #dc2626; margin: 0 0 0.5rem 0; font-size: 1.125rem;">Fout bij laden van groepen</h3>\n            <p style="color: #7f1d1d; margin: 0; font-size: 0.875rem;">${s.message}</p>\n          </div>\n          <button class="btn btn-primary" id="step2-try-again-btn">\n            Probeer opnieuw\n          </button>\n        </div>\n      `;const n=t.querySelector("#step2-try-again-btn");n&&n.addEventListener("click",()=>{e()})}}},window.initializeStep3=async function(){a.debug(" Initializing Step 3: Keywords");const e=document.getElementById("setup-keyword-input"),t=document.getElementById("setup-add-keyword-btn"),n=document.getElementById("setup-keywords-container");document.getElementById("setup-keywords-empty"),document.getElementById("setup-step-3-btn"),e&&t&&n&&(await wt(),t.addEventListener("click",async()=>{await bt()}),e.addEventListener("keypress",e=>{"Enter"===e.key&&bt()}),e.addEventListener("input",()=>{vt()}),vt())},window.initializeStep4=async function(){a.debug(" Initializing setup step 4: thank you screen");const e=document.getElementById("setup-step-4-btn");e&&(e.disabled=!1)};
